<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å£²ä¸Šåˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .comparison-positive { color: #10b981; }
        .comparison-negative { color: #ef4444; }
        .rank-1 { background-color: #fef3c7; }
        .rank-2 { background-color: #e5e7eb; }
        .rank-3 { background-color: #fed7aa; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="bg-white rounded-lg shadow-sm p-4 mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                <h1 class="text-2xl font-bold text-gray-800">å£²ä¸Šåˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
                <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                    <!-- æœˆé¸æŠ -->
                    <select id="monthSelector" class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">æœˆã‚’é¸æŠ</option>
                    </select>
                    <!-- CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
                    <label class="px-4 py-2 bg-blue-600 text-white rounded-lg cursor-pointer hover:bg-blue-700 transition text-center">
                        CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                        <input type="file" id="csvFile" accept=".csv" class="hidden">
                    </label>
                </div>
            </div>
        </header>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div id="mainContent" class="hidden">
            <!-- ç·å£²ä¸Šã‚µãƒãƒªãƒ¼ -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">ç·å£²ä¸Šã‚µãƒãƒªãƒ¼</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="text-center p-4 bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-600">æ–½è¡“å£²ä¸Š</p>
                        <p id="treatmentTotal" class="text-2xl font-bold text-gray-800">-</p>
                        <p id="treatmentComparison" class="text-sm mt-1">-</p>
                    </div>
                    <div class="text-center p-4 bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-600">ç‰©å“å£²ä¸Š</p>
                        <p id="productTotal" class="text-2xl font-bold text-gray-800">-</p>
                        <p id="productComparison" class="text-sm mt-1">-</p>
                    </div>
                    <div class="text-center p-4 bg-blue-50 rounded-lg">
                        <p class="text-sm text-gray-600">ç·å£²ä¸Š</p>
                        <p id="grandTotal" class="text-2xl font-bold text-blue-800">-</p>
                        <p id="grandComparison" class="text-sm mt-1">-</p>
                    </div>
                </div>
            </div>

            <!-- æœˆæ¬¡æ¨ç§»ã‚°ãƒ©ãƒ• -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">å£²ä¸Šæ¨ç§»</h2>
                <div style="position: relative; height:300px;">
                    <canvas id="salesChart"></canvas>
                </div>
            </div>

            <!-- æ–½è¡“ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold">æ–½è¡“ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
                    <div class="flex gap-2">
                        <button onclick="showRanking('amount')" id="amountBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm">å£²ä¸Šé †</button>
                        <button onclick="showRanking('count')" id="countBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm">ä»¶æ•°é †</button>
                        <button onclick="toggleChartView()" id="chartBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm">å††ã‚°ãƒ©ãƒ•</button>
                    </div>
                </div>
                <div id="treatmentRanking" class="overflow-x-auto">
                    <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ†ãƒ¼ãƒ–ãƒ« -->
                </div>
                <div id="pieChartContainer" class="hidden" style="position: relative; height:400px;">
                    <canvas id="treatmentPieChart"></canvas>
                </div>
            </div>

            <!-- ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">æ–½è¡“ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-medium text-green-700 mb-3">ğŸ“ˆ æˆé•·ä¸­ã®æ–½è¡“ (TOP 5)</h3>
                        <div id="growingTreatments" class="space-y-2">
                            <!-- æˆé•·ä¸­ã®æ–½è¡“ãƒªã‚¹ãƒˆ -->
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-medium text-red-700 mb-3">ğŸ“‰ æ¸›å°‘ä¸­ã®æ–½è¡“ (TOP 5)</h3>
                        <div id="decliningTreatments" class="space-y-2">
                            <!-- æ¸›å°‘ä¸­ã®æ–½è¡“ãƒªã‚¹ãƒˆ -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç‰©å“ã‚µãƒãƒªãƒ¼ -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h2 class="text-xl font-semibold mb-4">ç‰©å“å£²ä¸Š</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="p-4 border rounded-lg">
                        <h3 class="font-medium text-gray-700 mb-2">å¤–ç”¨è–¬</h3>
                        <p id="externalMedicine" class="text-xl font-bold">-</p>
                        <p id="externalComparison" class="text-sm text-gray-600 mt-1">-</p>
                    </div>
                    <div class="p-4 border rounded-lg">
                        <h3 class="font-medium text-gray-700 mb-2">å†…æœè–¬</h3>
                        <p id="internalMedicine" class="text-xl font-bold">-</p>
                        <p id="internalComparison" class="text-sm text-gray-600 mt-1">-</p>
                    </div>
                    <div class="p-4 border rounded-lg">
                        <h3 class="font-medium text-gray-700 mb-2">åŒ–ç²§å“</h3>
                        <p id="cosmetics" class="text-xl font-bold">-</p>
                        <p id="cosmeticsComparison" class="text-sm text-gray-600 mt-1">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
        <div id="emptyState" class="text-center py-12">
            <p class="text-gray-500 text-lg">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</p>
        </div>
    </div>

    <!-- ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ« -->
    <div class="fixed bottom-4 right-4">
        <button onclick="clearAllData()" class="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700">
            ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
        </button>
        <button onclick="showDebugInfo()" class="px-3 py-1 bg-gray-600 text-white text-sm rounded hover:bg-gray-700 ml-2">
            ãƒ‡ãƒãƒƒã‚°æƒ…å ±
        </button>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let salesData = {};
        let currentMonth = '';
        let rankingMode = 'amount';
        let salesChart = null;
        let pieChart = null;
        let showPieChart = false;

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            loadStoredData();
            document.getElementById('csvFile').addEventListener('change', handleFileUpload);
            document.getElementById('monthSelector').addEventListener('change', handleMonthChange);
        });

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        function loadStoredData() {
            const stored = localStorage.getItem('salesData');
            if (stored) {
                salesData = JSON.parse(stored);
                updateMonthSelector();
                if (Object.keys(salesData).length > 0) {
                    currentMonth = Object.keys(salesData).sort().pop();
                    document.getElementById('monthSelector').value = currentMonth;
                    displayData();
                }
            }
        }

        // CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            Papa.parse(file, {
                encoding: 'UTF-8',
                complete: function(results) {
                    processCSVData(results.data, file.name);
                },
                error: function(error) {
                    alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            });
        }

        // CSVãƒ‡ãƒ¼ã‚¿å‡¦ç†
        function processCSVData(data, filename) {
            console.log('Processing CSV data...');
            
            // ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰å¹´æœˆã‚’æŠ½å‡º (ä¾‹: ç§‘ç›®åˆ¥å£²ä¸Š_20250701-20250731.csv)
            const monthMatch = filename.match(/(\d{6})\d{2}/);
            if (!monthMatch) {
                alert('ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰å¹´æœˆã‚’ç‰¹å®šã§ãã¾ã›ã‚“ã§ã—ãŸ');
                return;
            }
            
            const yearMonth = monthMatch[1]; // 202507
            const formattedMonth = yearMonth.slice(0, 4) + 'å¹´' + yearMonth.slice(4, 6) + 'æœˆ';
            
            // ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®åˆæœŸåŒ–
            const monthData = {
                treatments: {},
                products: {
                    external: { amount: 0, count: 0 },
                    internal: { amount: 0, count: 0 },
                    cosmetics: { amount: 0, count: 0 }
                },
                totals: {
                    treatment: { amount: 0, count: 0 },
                    product: { amount: 0, count: 0 },
                    grand: { amount: 0, count: 0 }
                }
            };

            // å‰Šé™¤å¯¾è±¡é …ç›®ï¼ˆã‚¹ãƒšãƒ¼ã‚¹ã‚‚å«ã‚ã¦å®Œå…¨ä¸€è‡´ã§ãƒã‚§ãƒƒã‚¯ï¼‰
            const excludeItems = ['è¨ºå¯Ÿæ–™ï¼ˆè‡ªè²»ï¼‰', 'èª¿æ•´é‡‘é¡', 'äºˆç´„ç”¨', 'èª¿æ•´é‡‘é¡(230)'];
            
            // ãƒ‡ãƒ¼ã‚¿è§£æ
            let inTreatmentSection = false;
            let inProductSection = false;
            let foundTreatmentData = false;
            let foundProductData = false;
            
            // CSVã‚’è§£æã—ã¦ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¨é …ç›®ã‚’ç‰¹å®š
            for (let i = 0; i < data.length; i++) {
                const row = data[i];
                if (!row || row.length < 5) continue;
                
                // ã‚«ãƒ©ãƒ ã®å€¤ã‚’å–å¾—ï¼ˆBOMã‚„ä½™åˆ†ãªæ–‡å­—ã‚’é™¤å»ï¼‰
                // æœ€åˆã®è¡Œã®æœ€åˆã®ã‚»ãƒ«ã«å«ã¾ã‚Œã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹BOMã‚’é™¤å»
                let col0 = (row[0] || '').trim();
                if (i === 0 && col0.charCodeAt(0) === 0xFEFF) {
                    col0 = col0.substring(1);
                }
                // ã€Œç®¡ç†åç§°ã€ã®å‰ã«ç‰¹æ®Šæ–‡å­—ãŒã‚ã‚‹å ´åˆã‚‚å¯¾å¿œ
                col0 = col0.replace(/^[ï»¿\uFEFF]+/, '');
                
                const col1 = (row[1] || '').trim();
                const col2 = (row[2] || '0').replace(/[,ï¼Œ"]/g, '');
                const col3 = (row[3] || '0').replace(/[,ï¼Œ"]/g, '');
                const col4 = (row[4] || '0').replace(/[,ï¼Œ"]/g, '');
                
                // ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›
                if (i < 15 || (i > 28 && i < 35)) {
                    console.log(`Row ${i}:`, {col0, col1, col2, col3});
                }
                
                // ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ¤å®šï¼ˆåˆ—0ã«"æ–½è¡“"ã¾ãŸã¯"ç‰©å“"ãŒå«ã¾ã‚Œã‚‹ï¼‰
                if (col0.includes('æ–½è¡“') && col1 === '') {
                    inTreatmentSection = true;
                    inProductSection = false;
                    console.log(`Row ${i}: Entering treatment section`);
                    continue;
                }
                if (col0.includes('ç‰©å“') && col1 === '') {
                    inTreatmentSection = false;
                    inProductSection = true;
                    console.log(`Row ${i}: Entering product section`);
                    continue;
                }
                
                // åˆè¨ˆè¡Œã®å‡¦ç†ï¼ˆåˆ—1ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ï¼‰
                if (col1 === 'æ–½è¡“åˆè¨ˆ') {
                    monthData.totals.treatment.amount = parseInt(col2) || 0;
                    monthData.totals.treatment.count = parseInt(col3) || 0;
                    console.log(`Row ${i}: Treatment total:`, monthData.totals.treatment);
                    continue;
                }
                if (col1 === 'ç‰©å“åˆè¨ˆ') {
                    monthData.totals.product.amount = parseInt(col2) || 0;
                    monthData.totals.product.count = parseInt(col3) || 0;
                    console.log(`Row ${i}: Product total:`, monthData.totals.product);
                    continue;
                }
                if (col1 === 'ç·åˆè¨ˆ') {
                    monthData.totals.grand.amount = parseInt(col2) || 0;
                    monthData.totals.grand.count = parseInt(col3) || 0;
                    console.log(`Row ${i}: Grand total:`, monthData.totals.grand);
                    continue;
                }
                
                // ãƒ‡ãƒ¼ã‚¿è¡Œã®å‡¦ç†
                // åˆ—0ã«é …ç›®åãŒã‚ã‚Šã€åˆ—1ãŒç©ºã®è¡ŒãŒãƒ‡ãƒ¼ã‚¿è¡Œ
                if (col0 && col0.length > 0 && col0 !== 'ç®¡ç†åç§°' && col0 !== 'æ–½è¡“' && col0 !== 'ç‰©å“' && col1 === '') {
                    // å‰Šé™¤å¯¾è±¡é …ç›®ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆå‰å¾Œã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’é™¤å»ã—ã¦æ¯”è¼ƒï¼‰
                    const itemNameTrimmed = col0.trim();
                    
                    // ãƒ‡ãƒãƒƒã‚°ï¼šã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿è¡Œã‚’è¡¨ç¤º
                    if (inTreatmentSection || inProductSection) {
                        console.log(`Row ${i}: Processing - col0:'${col0}', col2:'${col2}', col3:'${col3}'`);
                    }
                    
                    if (excludeItems.includes(itemNameTrimmed)) {
                        console.log(`Row ${i}: Excluded item:`, col0);
                        continue;
                    }
                    
                    const amount = parseInt(col2) || 0;
                    const count = parseInt(col3) || 0;
                    const avgPrice = parseInt(col4) || 0;
                    
                    // æ–½è¡“é …ç›®ã®å‡¦ç†
                    if (inTreatmentSection) {
                        console.log(`Row ${i}: In treatment section - amount:${amount}, count:${count}`);
                        
                        if (amount > 0) {
                            // ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªï¼ˆã€ã§å§‹ã¾ã‚‹é …ç›®ï¼‰ã‚’é™¤å¤–
                            const isSubCategory = col0.match(/^ã€/);
                            
                            console.log(`Row ${i}: Checking treatment - col0:'${col0}', sub:${isSubCategory}`);
                            
                            if (!isSubCategory) {
                                monthData.treatments[itemNameTrimmed] = { amount, count, avgPrice };
                                foundTreatmentData = true;
                                console.log(`Row ${i}: âœ“ Added treatment:`, itemNameTrimmed, { amount, count, avgPrice });
                            } else {
                                console.log(`Row ${i}: âœ— Skipped subcategory:`, col0);
                            }
                        } else {
                            console.log(`Row ${i}: No amount for:`, col0);
                        }
                    }
                    // ç‰©å“é …ç›®ã®å‡¦ç†
                    else if (inProductSection) {
                        console.log(`Row ${i}: In product section - checking:`, itemNameTrimmed);
                        
                        if (itemNameTrimmed === 'å¤–ç”¨') {
                            monthData.products.external = { amount, count };
                            foundProductData = true;
                            console.log(`Row ${i}: Added external medicine:`, { amount, count });
                        } else if (itemNameTrimmed === 'å†…æœ') {
                            monthData.products.internal = { amount, count };
                            foundProductData = true;
                            console.log(`Row ${i}: Added internal medicine:`, { amount, count });
                        } else if (itemNameTrimmed === 'åŒ–ç²§å“') {
                            monthData.products.cosmetics = { amount, count };
                            foundProductData = true;
                            console.log(`Row ${i}: Added cosmetics:`, { amount, count });
                        }
                    }
                }
            }
            
            console.log('Processed data:', monthData);
            console.log('Found treatment data:', foundTreatmentData);
            console.log('Found product data:', foundProductData);
            
            // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
            salesData[formattedMonth] = monthData;
            localStorage.setItem('salesData', JSON.stringify(salesData));
            
            // è¡¨ç¤ºæ›´æ–°
            currentMonth = formattedMonth;
            updateMonthSelector();
            document.getElementById('monthSelector').value = currentMonth;
            displayData();
            updateChart();
            
            alert(`${formattedMonth}ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
        }

        // æœˆé¸æŠã‚»ãƒ¬ã‚¯ã‚¿ã®æ›´æ–°
        function updateMonthSelector() {
            const selector = document.getElementById('monthSelector');
            const months = Object.keys(salesData).sort();
            
            selector.innerHTML = '<option value="">æœˆã‚’é¸æŠ</option>';
            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = month;
                selector.appendChild(option);
            });
        }

        // æœˆå¤‰æ›´å‡¦ç†
        function handleMonthChange(event) {
            currentMonth = event.target.value;
            if (currentMonth) {
                displayData();
            } else {
                document.getElementById('mainContent').classList.add('hidden');
                document.getElementById('emptyState').classList.remove('hidden');
            }
        }

        // ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
        function displayData() {
            if (!currentMonth || !salesData[currentMonth]) return;
            
            document.getElementById('mainContent').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            
            const data = salesData[currentMonth];
            
            // ç·å£²ä¸Šã‚µãƒãƒªãƒ¼è¡¨ç¤º
            displaySummary(data);
            
            // æ–½è¡“ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
            displayTreatmentRanking(data.treatments);
            
            // ç‰©å“ã‚µãƒãƒªãƒ¼è¡¨ç¤º
            displayProductSummary(data.products);
            
            // ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æè¡¨ç¤º
            displayTrendAnalysis();
            
            // ã‚°ãƒ©ãƒ•æ›´æ–°ï¼ˆè¤‡æ•°æœˆã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆï¼‰
            if (Object.keys(salesData).length > 0) {
                updateChart();
            }
        }

        // ç·å£²ä¸Šã‚µãƒãƒªãƒ¼è¡¨ç¤º
        function displaySummary(data) {
            // é‡‘é¡ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            const formatAmount = (amount) => 'Â¥' + amount.toLocaleString();
            
            // å‰æœˆãƒ‡ãƒ¼ã‚¿å–å¾—
            const months = Object.keys(salesData).sort();
            const currentIndex = months.indexOf(currentMonth);
            const previousMonth = currentIndex > 0 ? months[currentIndex - 1] : null;
            const previousData = previousMonth ? salesData[previousMonth] : null;
            
            // æ¯”è¼ƒè¨ˆç®—
            const calculateComparison = (current, previous) => {
                if (!previous || previous === 0) return '<span class="text-gray-400">å‰æœˆãƒ‡ãƒ¼ã‚¿ãªã—</span>';
                const diff = current - previous;
                const percent = Math.round((diff / previous) * 100);
                const sign = diff >= 0 ? '+' : '';
                const className = diff >= 0 ? 'comparison-positive' : 'comparison-negative';
                return `<span class="${className}">${sign}${percent}% (${sign}${formatAmount(diff)})</span>`;
            };
            
            // æ–½è¡“å£²ä¸Š
            document.getElementById('treatmentTotal').textContent = formatAmount(data.totals.treatment.amount);
            document.getElementById('treatmentComparison').innerHTML = previousData ? 
                calculateComparison(data.totals.treatment.amount, previousData.totals.treatment.amount) : 
                '<span class="text-gray-400">å‰æœˆãƒ‡ãƒ¼ã‚¿ãªã—</span>';
            
            // ç‰©å“å£²ä¸Š
            document.getElementById('productTotal').textContent = formatAmount(data.totals.product.amount);
            document.getElementById('productComparison').innerHTML = previousData ? 
                calculateComparison(data.totals.product.amount, previousData.totals.product.amount) : 
                '<span class="text-gray-400">å‰æœˆãƒ‡ãƒ¼ã‚¿ãªã—</span>';
            
            // ç·å£²ä¸Š
            document.getElementById('grandTotal').textContent = formatAmount(data.totals.grand.amount);
            document.getElementById('grandComparison').innerHTML = previousData ? 
                calculateComparison(data.totals.grand.amount, previousData.totals.grand.amount) : 
                '<span class="text-gray-400">å‰æœˆãƒ‡ãƒ¼ã‚¿ãªã—</span>';
        }

        // æ–½è¡“ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
        function displayTreatmentRanking(treatments) {
            console.log('Displaying treatment ranking:', treatments);
            console.log('Treatment keys:', Object.keys(treatments));
            console.log('Treatment count:', Object.keys(treatments).length);
            
            if (!treatments || Object.keys(treatments).length === 0) {
                document.getElementById('treatmentRanking').innerHTML = '<p class="text-gray-500">æ–½è¡“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            const sortedTreatments = Object.entries(treatments).sort((a, b) => {
                if (rankingMode === 'amount') {
                    return b[1].amount - a[1].amount;
                } else {
                    return b[1].count - a[1].count;
                }
            });
            
            let html = `
                <table class="w-full">
                    <thead>
                        <tr class="border-b">
                            <th class="text-left py-2 px-1 w-12">é †ä½</th>
                            <th class="text-left py-2 px-2">æ–½è¡“å</th>
                            <th class="text-right py-2 px-2">å£²ä¸Šé‡‘é¡</th>
                            <th class="text-right py-2 px-2">å‰æœˆæ¯”</th>
                            <th class="text-right py-2 px-2">ä»¶æ•°</th>
                            <th class="text-right py-2 px-2">å¹³å‡å˜ä¾¡</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // å‰æœˆãƒ‡ãƒ¼ã‚¿å–å¾—
            const months = Object.keys(salesData).sort();
            const currentIndex = months.indexOf(currentMonth);
            const previousMonth = currentIndex > 0 ? months[currentIndex - 1] : null;
            const previousData = previousMonth ? salesData[previousMonth].treatments : null;
            
            sortedTreatments.forEach((item, index) => {
                const [name, data] = item;
                const rankClass = index < 3 ? `rank-${index + 1}` : '';
                
                // å‰æœˆæ¯”è¨ˆç®—
                let changeDisplay = '<span class="text-gray-400">-</span>';
                if (previousData && previousData[name]) {
                    const prevAmount = previousData[name].amount;
                    const change = data.amount - prevAmount;
                    const changePercent = Math.round((change / prevAmount) * 100);
                    const changeClass = change >= 0 ? 'comparison-positive' : 'comparison-negative';
                    const sign = change >= 0 ? '+' : '';
                    changeDisplay = `<span class="${changeClass}">${sign}${changePercent}%</span>`;
                }
                
                html += `
                    <tr class="border-b ${rankClass} fade-in">
                        <td class="py-3 px-1">${index + 1}</td>
                        <td class="py-3 px-2">${name}</td>
                        <td class="text-right py-3 px-2 font-semibold">Â¥${data.amount.toLocaleString()}</td>
                        <td class="text-right py-3 px-2">${changeDisplay}</td>
                        <td class="text-right py-3 px-2">${data.count.toLocaleString()}ä»¶</td>
                        <td class="text-right py-3 px-2">Â¥${data.avgPrice.toLocaleString()}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            document.getElementById('treatmentRanking').innerHTML = html;
        }

        // ç‰©å“ã‚µãƒãƒªãƒ¼è¡¨ç¤º
        function displayProductSummary(products) {
            const formatAmount = (amount) => 'Â¥' + amount.toLocaleString();
            
            // å‰æœˆãƒ‡ãƒ¼ã‚¿å–å¾—
            const months = Object.keys(salesData).sort();
            const currentIndex = months.indexOf(currentMonth);
            const previousMonth = currentIndex > 0 ? months[currentIndex - 1] : null;
            const previousProducts = previousMonth ? salesData[previousMonth].products : null;
            
            // æ¯”è¼ƒè¡¨ç¤º
            const showComparison = (current, previous) => {
                if (!previous || previous.amount === 0) return 'å‰æœˆãƒ‡ãƒ¼ã‚¿ãªã—';
                const diff = current.amount - previous.amount;
                const percent = Math.round((diff / previous.amount) * 100);
                const sign = diff >= 0 ? '+' : '';
                const className = diff >= 0 ? 'comparison-positive' : 'comparison-negative';
                return `<span class="${className}">å‰æœˆæ¯”: ${sign}${percent}%</span>`;
            };
            
            // å¤–ç”¨è–¬
            document.getElementById('externalMedicine').textContent = formatAmount(products.external.amount);
            document.getElementById('externalComparison').innerHTML = previousProducts ? 
                showComparison(products.external, previousProducts.external) : 'å‰æœˆãƒ‡ãƒ¼ã‚¿ãªã—';
            
            // å†…æœè–¬
            document.getElementById('internalMedicine').textContent = formatAmount(products.internal.amount);
            document.getElementById('internalComparison').innerHTML = previousProducts ? 
                showComparison(products.internal, previousProducts.internal) : 'å‰æœˆãƒ‡ãƒ¼ã‚¿ãªã—';
            
            // åŒ–ç²§å“
            document.getElementById('cosmetics').textContent = formatAmount(products.cosmetics.amount);
            document.getElementById('cosmeticsComparison').innerHTML = previousProducts ? 
                showComparison(products.cosmetics, previousProducts.cosmetics) : 'å‰æœˆãƒ‡ãƒ¼ã‚¿ãªã—';
        }

        // ã‚°ãƒ©ãƒ•æ›´æ–°
        function updateChart() {
            const ctx = document.getElementById('salesChart').getContext('2d');
            const months = Object.keys(salesData).sort();
            
            const chartData = {
                labels: months,
                datasets: [
                    {
                        label: 'æ–½è¡“å£²ä¸Š',
                        data: months.map(month => salesData[month].totals.treatment.amount),
                        backgroundColor: 'rgba(59, 130, 246, 0.8)',
                        borderColor: 'rgb(59, 130, 246)',
                        borderWidth: 1
                    },
                    {
                        label: 'ç‰©å“å£²ä¸Š',
                        data: months.map(month => salesData[month].totals.product.amount),
                        backgroundColor: 'rgba(251, 146, 60, 0.8)',
                        borderColor: 'rgb(251, 146, 60)',
                        borderWidth: 1
                    }
                ]
            };

            if (salesChart) {
                salesChart.destroy();
            }

            salesChart = new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += 'Â¥' + context.parsed.y.toLocaleString();
                                    return label;
                                },
                                afterLabel: function(context) {
                                    const monthData = salesData[context.label];
                                    if (monthData) {
                                        const total = monthData.totals.grand.amount;
                                        const percentage = Math.round((context.parsed.y / total) * 100);
                                        return `ç·å£²ä¸Šã®${percentage}%`;
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'Â¥' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // ãƒ©ãƒ³ã‚­ãƒ³ã‚°åˆ‡ã‚Šæ›¿ãˆ
        function showRanking(mode) {
            rankingMode = mode;
            showPieChart = false;
            
            // ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«åˆ‡ã‚Šæ›¿ãˆ
            const amountBtn = document.getElementById('amountBtn');
            const countBtn = document.getElementById('countBtn');
            const chartBtn = document.getElementById('chartBtn');
            
            if (mode === 'amount') {
                amountBtn.className = 'px-4 py-2 bg-blue-600 text-white rounded-lg text-sm';
                countBtn.className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm';
            } else {
                amountBtn.className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm';
                countBtn.className = 'px-4 py-2 bg-blue-600 text-white rounded-lg text-sm';
            }
            chartBtn.className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm';
            
            // è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('treatmentRanking').classList.remove('hidden');
            document.getElementById('pieChartContainer').classList.add('hidden');
            
            // ãƒ©ãƒ³ã‚­ãƒ³ã‚°å†è¡¨ç¤º
            if (currentMonth && salesData[currentMonth]) {
                displayTreatmentRanking(salesData[currentMonth].treatments);
            }
        }
        
        // å††ã‚°ãƒ©ãƒ•è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        function toggleChartView() {
            showPieChart = !showPieChart;
            const chartBtn = document.getElementById('chartBtn');
            
            if (showPieChart) {
                chartBtn.className = 'px-4 py-2 bg-blue-600 text-white rounded-lg text-sm';
                document.getElementById('treatmentRanking').classList.add('hidden');
                document.getElementById('pieChartContainer').classList.remove('hidden');
                displayPieChart();
            } else {
                chartBtn.className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm';
                document.getElementById('treatmentRanking').classList.remove('hidden');
                document.getElementById('pieChartContainer').classList.add('hidden');
            }
        }
        
        // ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æè¡¨ç¤º
        function displayTrendAnalysis() {
            const months = Object.keys(salesData).sort();
            const currentIndex = months.indexOf(currentMonth);
            
            // å°‘ãªãã¨ã‚‚2ãƒ¶æœˆåˆ†ã®ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦
            if (months.length < 2 || currentIndex < 1) {
                document.getElementById('growingTreatments').innerHTML = '<p class="text-gray-500">ãƒ‡ãƒ¼ã‚¿ãŒä¸ååˆ†ã§ã™</p>';
                document.getElementById('decliningTreatments').innerHTML = '<p class="text-gray-500">ãƒ‡ãƒ¼ã‚¿ãŒä¸ååˆ†ã§ã™</p>';
                return;
            }
            
            const currentData = salesData[currentMonth].treatments;
            const previousMonth = months[currentIndex - 1];
            const previousData = salesData[previousMonth].treatments;
            
            // å¤‰åŒ–ç‡ã‚’è¨ˆç®—
            const changes = [];
            Object.keys(currentData).forEach(name => {
                if (previousData[name]) {
                    const currentAmount = currentData[name].amount;
                    const previousAmount = previousData[name].amount;
                    const change = currentAmount - previousAmount;
                    const changePercent = (change / previousAmount) * 100;
                    
                    changes.push({
                        name: name,
                        currentAmount: currentAmount,
                        previousAmount: previousAmount,
                        change: change,
                        changePercent: changePercent
                    });
                }
            });
            
            // æ–°è¦æ–½è¡“ï¼ˆå‰æœˆã«ãªã„æ–½è¡“ï¼‰
            Object.keys(currentData).forEach(name => {
                if (!previousData[name] && currentData[name].amount > 0) {
                    changes.push({
                        name: name,
                        currentAmount: currentData[name].amount,
                        previousAmount: 0,
                        change: currentData[name].amount,
                        changePercent: 100,
                        isNew: true
                    });
                }
            });
            
            // æˆé•·ç‡ã§ã‚½ãƒ¼ãƒˆ
            changes.sort((a, b) => b.changePercent - a.changePercent);
            
            // æˆé•·ä¸­ã®æ–½è¡“ï¼ˆä¸Šä½5ä»¶ï¼‰
            const growing = changes.filter(item => item.change > 0).slice(0, 5);
            let growingHtml = '';
            growing.forEach(item => {
                const newBadge = item.isNew ? '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded ml-2">NEW</span>' : '';
                growingHtml += `
                    <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                        <div class="flex items-center">
                            <span class="font-medium">${item.name}</span>${newBadge}
                        </div>
                        <div class="text-right">
                            <span class="text-green-700 font-bold">+${Math.round(item.changePercent)}%</span>
                            <div class="text-sm text-gray-600">Â¥${item.currentAmount.toLocaleString()}</div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('growingTreatments').innerHTML = growingHtml || '<p class="text-gray-500">æˆé•·ä¸­ã®æ–½è¡“ãŒã‚ã‚Šã¾ã›ã‚“</p>';
            
            // æ¸›å°‘ä¸­ã®æ–½è¡“ï¼ˆä¸‹ä½5ä»¶ï¼‰
            const declining = changes.filter(item => item.change < 0).slice(-5).reverse();
            let decliningHtml = '';
            declining.forEach(item => {
                decliningHtml += `
                    <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg">
                        <span class="font-medium">${item.name}</span>
                        <div class="text-right">
                            <span class="text-red-700 font-bold">${Math.round(item.changePercent)}%</span>
                            <div class="text-sm text-gray-600">Â¥${item.currentAmount.toLocaleString()}</div>
                        </div>
                    </div>
                `;
            });
            document.getElementById('decliningTreatments').innerHTML = decliningHtml || '<p class="text-gray-500">æ¸›å°‘ä¸­ã®æ–½è¡“ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        }
        
        // å††ã‚°ãƒ©ãƒ•è¡¨ç¤º
        function displayPieChart() {
            if (!currentMonth || !salesData[currentMonth]) return;
            
            const treatments = salesData[currentMonth].treatments;
            const sortedTreatments = Object.entries(treatments).sort((a, b) => {
                return rankingMode === 'amount' ? b[1].amount - a[1].amount : b[1].count - a[1].count;
            });
            
            // ä¸Šä½10ä»¶ã‚’å–å¾—ã€æ®‹ã‚Šã¯ã€Œãã®ä»–ã€ã«ã¾ã¨ã‚ã‚‹
            const topTreatments = sortedTreatments.slice(0, 10);
            const otherTreatments = sortedTreatments.slice(10);
            
            const labels = topTreatments.map(([name]) => name);
            const data = topTreatments.map(([, data]) => rankingMode === 'amount' ? data.amount : data.count);
            
            if (otherTreatments.length > 0) {
                const otherValue = otherTreatments.reduce((sum, [, data]) => {
                    return sum + (rankingMode === 'amount' ? data.amount : data.count);
                }, 0);
                labels.push('ãã®ä»–');
                data.push(otherValue);
            }
            
            const ctx = document.getElementById('treatmentPieChart').getContext('2d');
            
            if (pieChart) {
                pieChart.destroy();
            }
            
            pieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(251, 146, 60, 0.8)',
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(168, 85, 247, 0.8)',
                            'rgba(236, 72, 153, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(6, 182, 212, 0.8)',
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(84, 56, 255, 0.8)',
                            'rgba(52, 211, 153, 0.8)',
                            'rgba(156, 163, 175, 0.8)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                generateLabels: function(chart) {
                                    const original = Chart.defaults.plugins.legend.labels.generateLabels;
                                    const labels = original.call(this, chart);
                                    
                                    labels.forEach((label, index) => {
                                        const value = chart.data.datasets[0].data[index];
                                        const total = chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((value / total) * 100);
                                        
                                        if (rankingMode === 'amount') {
                                            label.text = `${label.text}: Â¥${value.toLocaleString()} (${percentage}%)`;
                                        } else {
                                            label.text = `${label.text}: ${value}ä»¶ (${percentage}%)`;
                                        }
                                    });
                                    
                                    return labels;
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    
                                    if (rankingMode === 'amount') {
                                        return `${label}: Â¥${value.toLocaleString()} (${percentage}%)`;
                                    } else {
                                        return `${label}: ${value}ä»¶ (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
        function clearAllData() {
            if (confirm('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.removeItem('salesData');
                salesData = {};
                currentMonth = '';
                updateMonthSelector();
                document.getElementById('mainContent').classList.add('hidden');
                document.getElementById('emptyState').classList.remove('hidden');
                if (salesChart) {
                    salesChart.destroy();
                    salesChart = null;
                }
                if (pieChart) {
                    pieChart.destroy();
                    pieChart = null;
                }
                alert('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
            }
        }

        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤º
        function showDebugInfo() {
            console.log('Current salesData:', salesData);
            console.log('Current month:', currentMonth);
            if (currentMonth && salesData[currentMonth]) {
                console.log('Current month data:', salesData[currentMonth]);
                console.log('Treatments count:', Object.keys(salesData[currentMonth].treatments).length);
                console.log('Treatments:', salesData[currentMonth].treatments);
                console.log('Products:', salesData[currentMonth].products);
            }
            alert('ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ã—ã¾ã—ãŸï¼ˆF12ã‚­ãƒ¼ã§é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã‚’é–‹ã„ã¦ç¢ºèªï¼‰');
        }
    </script>
</body>
</html>