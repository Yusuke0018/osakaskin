<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>売上分析ダッシュボード</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .comparison-positive { color: #10b981; }
        .comparison-negative { color: #ef4444; }
        .rank-1 { background-color: #fef3c7; }
        .rank-2 { background-color: #e5e7eb; }
        .rank-3 { background-color: #fed7aa; }
        .treatment-name { cursor: pointer; }
        .treatment-name:hover { color: #2563eb; text-decoration: underline; }
        .clickable-section { cursor: pointer; transition: all 0.3s; }
        .clickable-section:hover { background-color: #f9fafb; }
        .product-card { cursor: pointer; transition: all 0.3s; }
        .product-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        
        /* 月選択セレクタのスタイル改善 */
        #monthSelector {
            font-size: 1.125rem;
            font-weight: 500;
            background-color: #f3f4f6;
        }
        #monthSelector:not(:placeholder-shown) {
            background-color: #dbeafe;
            border-color: #3b82f6;
        }
        select option {
            padding: 0.5rem;
            font-size: 1rem;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <!-- ヘッダー -->
        <header class="bg-white rounded-lg shadow-sm p-4 mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                <h1 class="text-2xl font-bold text-gray-800">売上分析ダッシュボード</h1>
                <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                    <!-- 月選択 -->
                    <select id="monthSelector" class="px-6 py-3 text-lg font-medium border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white min-w-[200px]">
                        <option value="">月を選択</option>
                    </select>
                    <!-- CSVアップロード -->
                    <label class="px-6 py-3 bg-blue-600 text-white rounded-lg cursor-pointer hover:bg-blue-700 transition text-center font-medium">
                        CSVアップロード
                        <input type="file" id="csvFile" accept=".csv" class="hidden">
                    </label>
                </div>
            </div>
            <!-- タブナビゲーション -->
            <div class="mt-4 border-t pt-4">
                <nav class="flex space-x-4" aria-label="ページ切り替え">
                    <button id="selfPayTab" onclick="switchTab('selfPay')" class="px-6 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg">
                        自費
                    </button>
                    <button id="insuranceTab" onclick="switchTab('insurance')" class="px-6 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">
                        保険
                    </button>
                </nav>
            </div>
        </header>

        <!-- 自費ページ -->
        <div id="selfPayContent" class="hidden">
            <!-- 総売上サマリー -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">総売上サマリー</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-600 text-center mb-2">施術</p>
                        <div class="text-center">
                            <p id="treatmentTotal" class="text-2xl font-bold text-gray-800">-</p>
                            <p id="treatmentComparison" class="text-sm mt-1">-</p>
                        </div>
                        <div class="mt-3 pt-3 border-t border-gray-200">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">件数</span>
                                <div class="text-right">
                                    <span id="treatmentCount" class="font-semibold">-</span>
                                    <p id="treatmentCountComparison" class="text-xs mt-0.5">-</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-600 text-center mb-2">物品</p>
                        <div class="text-center">
                            <p id="productTotal" class="text-2xl font-bold text-gray-800">-</p>
                            <p id="productComparison" class="text-sm mt-1">-</p>
                        </div>
                        <div class="mt-3 pt-3 border-t border-gray-200">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">件数</span>
                                <div class="text-right">
                                    <span id="productCount" class="font-semibold">-</span>
                                    <p id="productCountComparison" class="text-xs mt-0.5">-</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="p-4 bg-blue-50 rounded-lg">
                        <p class="text-sm text-gray-600 text-center mb-2">総合計</p>
                        <div class="text-center">
                            <p id="grandTotal" class="text-2xl font-bold text-blue-800">-</p>
                            <p id="grandComparison" class="text-sm mt-1">-</p>
                        </div>
                        <div class="mt-3 pt-3 border-t border-gray-200">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">件数</span>
                                <div class="text-right">
                                    <span id="grandCount" class="font-semibold text-blue-800">-</span>
                                    <p id="grandCountComparison" class="text-xs mt-0.5">-</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 男女比率 -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6 hidden" id="genderRatioSection">
                <h2 class="text-xl font-semibold mb-4">男女比率</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-medium mb-3">人数内訳</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                                <span class="text-gray-700">男性</span>
                                <div class="text-right">
                                    <span id="maleCount" class="font-semibold text-lg">-</span>
                                    <span id="maleRatio" class="text-sm text-gray-600 ml-2">-</span>
                                </div>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-pink-50 rounded-lg">
                                <span class="text-gray-700">女性</span>
                                <div class="text-right">
                                    <span id="femaleCount" class="font-semibold text-lg">-</span>
                                    <span id="femaleRatio" class="text-sm text-gray-600 ml-2">-</span>
                                </div>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-gray-100 rounded-lg">
                                <span class="text-gray-700 font-medium">合計</span>
                                <span id="totalGenderCount" class="font-bold text-lg">-</span>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-medium mb-3">比率グラフ</h3>
                        <div style="position: relative; height:250px;">
                            <canvas id="genderChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 月次推移グラフ -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                    <h2 class="text-xl font-semibold">売上・件数推移</h2>
                    <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                        <select id="chartPeriod" class="px-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="12">過去1年間</option>
                            <option value="6">過去6ヶ月</option>
                            <option value="3">過去3ヶ月</option>
                            <option value="24">過去2年間</option>
                            <option value="all">全期間</option>
                            <option value="custom">期間を指定</option>
                        </select>
                        <div id="customPeriod" class="hidden flex flex-wrap gap-2 mt-2">
                            <select id="startMonth" class="px-4 py-2 border-2 border-gray-300 rounded-lg font-medium focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white min-w-[150px]">
                                <option value="">開始月</option>
                            </select>
                            <span class="self-center font-medium text-lg">〜</span>
                            <select id="endMonth" class="px-4 py-2 border-2 border-gray-300 rounded-lg font-medium focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white min-w-[150px]">
                                <option value="">終了月</option>
                            </select>
                            <button onclick="applyCustomPeriod()" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">適用</button>
                        </div>
                    </div>
                </div>
                <div style="position: relative; height:400px;">
                    <canvas id="salesChart"></canvas>
                </div>
            </div>

            <!-- 施術ランキング -->
            <div class="bg-white rounded-lg shadow-sm mb-6">
                <div class="clickable-section p-6 border-b" onclick="toggleSection('treatmentSection')">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl font-semibold">施術ランキング</h2>
                        <svg id="treatmentSectionIcon" class="w-6 h-6 text-gray-400 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                </div>
                <div id="treatmentSection" class="p-6 hidden">
                    <div class="flex gap-2 mb-4">
                        <button onclick="showRanking('amount')" id="amountBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm">売上順</button>
                        <button onclick="showRanking('count')" id="countBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm">件数順</button>
                        <button onclick="toggleChartView()" id="chartBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm">円グラフ</button>
                    </div>
                    <div id="treatmentRanking" class="overflow-x-auto">
                        <!-- ランキングテーブル -->
                    </div>
                    <div id="pieChartContainer" class="hidden" style="position: relative; height:400px;">
                        <canvas id="treatmentPieChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- 施術詳細モーダル -->
            <div id="treatmentDetailModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
                <div class="flex items-center justify-center min-h-screen p-4">
                    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[80vh] overflow-y-auto">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 id="modalTitle" class="text-xl font-semibold"></h2>
                                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            <div id="modalContent">
                                <div style="position: relative; height:400px;">
                                    <canvas id="treatmentDetailChart"></canvas>
                                </div>
                                <div id="treatmentGenderChart" class="mt-6 hidden">
                                    <h3 class="text-lg font-medium mb-3">男女比率</h3>
                                    <div style="position: relative; height:250px;">
                                        <canvas id="treatmentGenderRatioChart"></canvas>
                                    </div>
                                </div>
                                <div id="treatmentDetailTable" class="mt-6">
                                    <!-- 詳細テーブル -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 物品詳細モーダル -->
            <div id="productDetailModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
                <div class="flex items-center justify-center min-h-screen p-4">
                    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[80vh] overflow-y-auto">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 id="productModalTitle" class="text-xl font-semibold"></h2>
                                <button onclick="closeProductModal()" class="text-gray-400 hover:text-gray-600">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            <div id="productModalContent">
                                <div style="position: relative; height:400px;">
                                    <canvas id="productDetailChart"></canvas>
                                </div>
                                <div id="productDetailTable" class="mt-6">
                                    <!-- 詳細テーブル -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 物品サマリー -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h2 class="text-xl font-semibold mb-4">物品売上</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="p-4 border rounded-lg product-card" onclick="showProductDetail('external')">
                        <h3 class="font-medium text-gray-700 mb-2">外用薬</h3>
                        <p id="externalMedicine" class="text-xl font-bold">-</p>
                        <p id="externalComparison" class="text-sm text-gray-600 mt-1">-</p>
                    </div>
                    <div class="p-4 border rounded-lg product-card" onclick="showProductDetail('internal')">
                        <h3 class="font-medium text-gray-700 mb-2">内服薬</h3>
                        <p id="internalMedicine" class="text-xl font-bold">-</p>
                        <p id="internalComparison" class="text-sm text-gray-600 mt-1">-</p>
                    </div>
                    <div class="p-4 border rounded-lg product-card" onclick="showProductDetail('cosmetics')">
                        <h3 class="font-medium text-gray-700 mb-2">化粧品</h3>
                        <p id="cosmetics" class="text-xl font-bold">-</p>
                        <p id="cosmeticsComparison" class="text-sm text-gray-600 mt-1">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 初期メッセージ -->
        <div id="emptyState" class="text-center py-12">
            <p class="text-gray-500 text-lg">CSVファイルをアップロードしてください</p>
        </div>
        
        <!-- 保険ページ -->
        <div id="insuranceContent" class="hidden">
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">保険診療データ</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- 医療収益 -->
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-600 text-center mb-2">医療収益</p>
                        <div class="text-center">
                            <p id="medicalRevenue" class="text-2xl font-bold text-gray-800">-</p>
                            <p id="medicalRevenueComparison" class="text-sm mt-1"></p>
                        </div>
                    </div>
                    <!-- 初診件数 -->
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-600 text-center mb-2">初診件数</p>
                        <div class="text-center">
                            <p id="firstVisitCount" class="text-2xl font-bold text-gray-800">-</p>
                            <p id="firstVisitCountComparison" class="text-sm mt-1"></p>
                        </div>
                    </div>
                    <!-- 再診件数 -->
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-600 text-center mb-2">再診件数</p>
                        <div class="text-center">
                            <p id="returnVisitCount" class="text-2xl font-bold text-gray-800">-</p>
                            <p id="returnVisitCountComparison" class="text-sm mt-1"></p>
                        </div>
                    </div>
                    <!-- 新患数 -->
                    <div class="p-4 bg-blue-50 rounded-lg">
                        <p class="text-sm text-gray-600 text-center mb-2">新患数</p>
                        <div class="text-center">
                            <p id="newPatientCount" class="text-2xl font-bold text-blue-800">-</p>
                            <p id="newPatientCountComparison" class="text-sm mt-1"></p>
                        </div>
                    </div>
                    <!-- 受診者数 -->
                    <div class="p-4 bg-blue-50 rounded-lg">
                        <p class="text-sm text-gray-600 text-center mb-2">受診者数</p>
                        <div class="text-center">
                            <p id="totalPatientCount" class="text-2xl font-bold text-blue-800">-</p>
                            <p id="totalPatientCountComparison" class="text-sm mt-1"></p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 保険データグラフ -->
            <div id="insuranceChartArea" class="bg-white rounded-lg shadow-sm p-6 mt-6 hidden">
                <h3 class="text-lg font-semibold mb-4">推移グラフ</h3>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- 医療収益推移 -->
                    <div>
                        <h4 class="text-md font-medium mb-3">医療収益推移</h4>
                        <canvas id="insuranceRevenueChart" width="400" height="200"></canvas>
                    </div>
                    <!-- 受診者数推移 -->
                    <div>
                        <h4 class="text-md font-medium mb-3">受診者数推移</h4>
                        <canvas id="insurancePatientChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- 保険データが無い場合のメッセージ -->
            <div id="noInsuranceData" class="text-center py-12">
                <p class="text-gray-500 text-lg">保険CSVファイルをアップロードしてください</p>
            </div>
        </div>
    </div>

    <!-- デバッグパネル -->
    <div class="fixed bottom-4 right-4">
        <button onclick="clearAllData()" class="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700">
            データクリア
        </button>
        <button onclick="showDebugInfo()" class="px-3 py-1 bg-gray-600 text-white text-sm rounded hover:bg-gray-700 ml-2">
            デバッグ情報
        </button>
    </div>

    <script>
        // グローバル変数
        let salesData = {};
        let insuranceData = {}; // 保険データ用
        let currentMonth = '';
        let currentTab = 'selfPay'; // 現在のタブ（selfPay or insurance）
        let rankingMode = 'amount';
        let salesChart = null;
        let pieChart = null;
        let showPieChart = false;
        let detailChart = null;
        let chartPeriod = '12'; // デフォルトは過去1年間
        let productChart = null;
        let genderChart = null; // 男女比率グラフ用
        let treatmentGenderChart = null; // 施術詳細の男女比率グラフ用

        // 初期化
        document.addEventListener('DOMContentLoaded', () => {
            loadStoredData();
            document.getElementById('csvFile').addEventListener('change', handleFileUpload);
            document.getElementById('monthSelector').addEventListener('change', handleMonthChange);
            document.getElementById('chartPeriod').addEventListener('change', handleChartPeriodChange);
        });
        
        // タブ切り替え処理
        function switchTab(tab) {
            currentTab = tab;
            
            // タブのスタイル更新
            const selfPayTab = document.getElementById('selfPayTab');
            const insuranceTab = document.getElementById('insuranceTab');
            
            if (tab === 'selfPay') {
                selfPayTab.className = 'px-6 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg';
                insuranceTab.className = 'px-6 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300';
                
                // コンテンツの表示切り替え
                document.getElementById('selfPayContent').classList.remove('hidden');
                document.getElementById('insuranceContent').classList.add('hidden');
                
                // 自費データがある場合は表示
                if (currentMonth && salesData[currentMonth]) {
                    displayData();
                }
            } else {
                selfPayTab.className = 'px-6 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300';
                insuranceTab.className = 'px-6 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg';
                
                // コンテンツの表示切り替え
                document.getElementById('selfPayContent').classList.add('hidden');
                document.getElementById('insuranceContent').classList.remove('hidden');
                
                // 保険データがある場合は表示
                if (currentMonth && insuranceData[currentMonth]) {
                    displayInsuranceData();
                }
            }
        }

        // ローカルストレージからデータ読み込み
        function loadStoredData() {
            // 自費データの読み込み
            const stored = localStorage.getItem('salesData');
            if (stored) {
                salesData = JSON.parse(stored);
            }
            
            // 保険データの読み込み
            const storedInsurance = localStorage.getItem('insuranceData');
            if (storedInsurance) {
                insuranceData = JSON.parse(storedInsurance);
            }
            
            updateMonthSelector();
            
            // データがある場合は最新の月を表示
            const allMonths = [...Object.keys(salesData), ...Object.keys(insuranceData)];
            if (allMonths.length > 0) {
                currentMonth = allMonths.sort().pop();
                document.getElementById('monthSelector').value = currentMonth;
                
                // 現在のタブに応じて表示
                if (currentTab === 'selfPay' && salesData[currentMonth]) {
                    displayData();
                } else if (currentTab === 'insurance' && insuranceData[currentMonth]) {
                    displayInsuranceData();
                }
            }
        }

        // CSVファイルアップロード処理
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // 保険ファイルの場合は、Shift-JISエンコーディングで読み込む
            if (file.name.includes('保険')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const text = e.target.result;
                    processCSVData(text, file.name);
                };
                // Shift-JISで読み込み
                reader.readAsText(file, 'Shift-JIS');
            } else {
                // 自費ファイルは通常通りPapaParseで処理
                Papa.parse(file, {
                    encoding: 'UTF-8',
                    complete: function(results) {
                        processCSVData(results.data, file.name);
                    },
                    error: function(error) {
                        alert('CSVファイルの読み込みに失敗しました: ' + error.message);
                    }
                });
            }
        }

        // CSVデータ処理
        function processCSVData(data, filename) {
            console.log('Processing CSV data...');
            
            // ファイルタイプの判定（保険 or 自費）
            const isInsurance = filename.includes('保険');
            
            // ファイル名から年月を抽出
            let yearMonth = null;
            let formattedMonth = null;
            
            if (isInsurance) {
                // 保険ファイルの場合: 保険_202506.csv 形式
                const insuranceMatch = filename.match(/保険_(\d{6})/);
                if (insuranceMatch) {
                    yearMonth = insuranceMatch[1];
                }
            } else {
                // 自費ファイルの場合
                // パターン1: 202506-202506 形式
                const monthMatch1 = filename.match(/(\d{6})-\d{6}/);
                if (monthMatch1) {
                    yearMonth = monthMatch1[1];
                } else {
                    // パターン2: 20250701-20250731 形式
                    const monthMatch2 = filename.match(/(\d{6})\d{2}/);
                    if (monthMatch2) {
                        yearMonth = monthMatch2[1];
                    }
                }
            }
            
            if (!yearMonth) {
                alert('ファイル名から年月を特定できませんでした');
                return;
            }
            
            formattedMonth = yearMonth.slice(0, 4) + '年' + yearMonth.slice(4, 6) + '月';
            
            // 保険データの場合は別処理
            if (isInsurance) {
                processInsuranceData(data, formattedMonth);
                return;
            }
            
            // 以下、自費データの処理
            // ファイル名から性別を判定
            let gender = null;
            if (filename.includes('男性')) {
                gender = 'male';
            } else if (filename.includes('女性')) {
                gender = 'female';
            }
            
            // 既存のデータがある場合は取得、なければ初期化
            let monthData = salesData[formattedMonth] || {
                treatments: {},
                products: {
                    external: { amount: 0, count: 0 },
                    internal: { amount: 0, count: 0 },
                    cosmetics: { amount: 0, count: 0 }
                },
                totals: {
                    treatment: { amount: 0, count: 0 },
                    product: { amount: 0, count: 0 },
                    grand: { amount: 0, count: 0 }
                },
                gender: {
                    male: { amount: 0, count: 0, treatments: {}, products: {} },
                    female: { amount: 0, count: 0, treatments: {}, products: {} }
                },
                hasBothGenders: false  // 男女両方のデータがあるかのフラグ
            };

            // 削除対象項目（スペースも含めて完全一致でチェック）
            const excludeItems = ['診察料（自費）', '調整金額', '予約用', '調整金額(230)'];
            
            // データ解析
            let inTreatmentSection = false;
            let inProductSection = false;
            let foundTreatmentData = false;
            let foundProductData = false;
            
            // CSVを解析してセクションと項目を特定
            for (let i = 0; i < data.length; i++) {
                const row = data[i];
                if (!row || row.length < 5) continue;
                
                // カラムの値を取得（BOMや余分な文字を除去）
                // 最初の行の最初のセルに含まれる可能性のあるBOMを除去
                let col0 = (row[0] || '').trim();
                if (i === 0 && col0.charCodeAt(0) === 0xFEFF) {
                    col0 = col0.substring(1);
                }
                // 「管理名称」の前に特殊文字がある場合も対応
                col0 = col0.replace(/^[﻿\uFEFF]+/, '');
                
                const col1 = (row[1] || '').trim();
                const col2 = (row[2] || '0').replace(/[,，"]/g, '');
                const col3 = (row[3] || '0').replace(/[,，"]/g, '');
                const col4 = (row[4] || '0').replace(/[,，"]/g, '');
                
                // デバッグ出力
                if (i < 15 || (i > 28 && i < 35)) {
                    console.log(`Row ${i}:`, {col0, col1, col2, col3});
                }
                
                // セクション判定（列0に"施術"または"物品"が含まれる）
                if (col0.includes('施術') && col1 === '') {
                    inTreatmentSection = true;
                    inProductSection = false;
                    console.log(`Row ${i}: Entering treatment section`);
                    continue;
                }
                if (col0.includes('物品') && col1 === '') {
                    inTreatmentSection = false;
                    inProductSection = true;
                    console.log(`Row ${i}: Entering product section`);
                    continue;
                }
                
                // 合計行の処理（列1にデータがある）
                if (col1 === '施術合計') {
                    monthData.totals.treatment.amount = parseInt(col2) || 0;
                    monthData.totals.treatment.count = parseInt(col3) || 0;
                    console.log(`Row ${i}: Treatment total:`, monthData.totals.treatment);
                    continue;
                }
                if (col1 === '物品合計') {
                    monthData.totals.product.amount = parseInt(col2) || 0;
                    monthData.totals.product.count = parseInt(col3) || 0;
                    console.log(`Row ${i}: Product total:`, monthData.totals.product);
                    continue;
                }
                if (col1 === '総合計') {
                    monthData.totals.grand.amount = parseInt(col2) || 0;
                    monthData.totals.grand.count = parseInt(col3) || 0;
                    console.log(`Row ${i}: Grand total:`, monthData.totals.grand);
                    continue;
                }
                
                // データ行の処理
                // 列0に項目名があり、列1が空の行がデータ行
                if (col0 && col0.length > 0 && col0 !== '管理名称' && col0 !== '施術' && col0 !== '物品' && col1 === '') {
                    // 削除対象項目をチェック（前後のスペースを除去して比較）
                    const itemNameTrimmed = col0.trim();
                    
                    // デバッグ：すべてのデータ行を表示
                    if (inTreatmentSection || inProductSection) {
                        console.log(`Row ${i}: Processing - col0:'${col0}', col2:'${col2}', col3:'${col3}'`);
                    }
                    
                    if (excludeItems.includes(itemNameTrimmed)) {
                        console.log(`Row ${i}: Excluded item:`, col0);
                        continue;
                    }
                    
                    const amount = parseInt(col2) || 0;
                    const count = parseInt(col3) || 0;
                    const avgPrice = parseInt(col4) || 0;
                    
                    // 施術項目の処理
                    if (inTreatmentSection) {
                        console.log(`Row ${i}: In treatment section - amount:${amount}, count:${count}`);
                        
                        // インデントされた項目（前にスペースがある）を除外
                        const hasIndent = col0.match(/^[\s　]+/);
                        // サブカテゴリ（【で始まる項目）を除外
                        const isSubCategory = col0.match(/【/);
                        // 親カテゴリかどうかを判断（インデントがなく、次の行にインデントされた項目がある可能性）
                        const isParentCategory = !hasIndent && itemNameTrimmed === 'オンライン診療';
                        
                        console.log(`Row ${i}: Checking treatment - col0:'${col0}', sub:${isSubCategory}, parent:${isParentCategory}`);
                        
                        if (!hasIndent && !isSubCategory && !isParentCategory && amount > 0) {
                            // 性別データがある場合は性別ごとに保存
                            if (gender) {
                                monthData.gender[gender].treatments[itemNameTrimmed] = { amount, count, avgPrice };
                            } else {
                                monthData.treatments[itemNameTrimmed] = { amount, count, avgPrice };
                            }
                            foundTreatmentData = true;
                            console.log(`Row ${i}: ✓ Added treatment:`, itemNameTrimmed, { amount, count, avgPrice });
                        } else {
                            console.log(`Row ${i}: ✗ Skipped:`, col0, 'reason:', 
                                hasIndent ? 'indented' : 
                                isSubCategory ? 'subcategory' : 
                                isParentCategory ? 'parent category' : 
                                'no amount');
                        }
                    }
                    // 物品項目の処理
                    else if (inProductSection) {
                        console.log(`Row ${i}: In product section - checking:`, itemNameTrimmed);
                        
                        if (itemNameTrimmed === '外用') {
                            if (gender) {
                                monthData.gender[gender].products.external = { amount, count };
                            } else {
                                monthData.products.external = { amount, count };
                            }
                            foundProductData = true;
                            console.log(`Row ${i}: Added external medicine:`, { amount, count });
                        } else if (itemNameTrimmed === '内服') {
                            if (gender) {
                                monthData.gender[gender].products.internal = { amount, count };
                            } else {
                                monthData.products.internal = { amount, count };
                            }
                            foundProductData = true;
                            console.log(`Row ${i}: Added internal medicine:`, { amount, count });
                        } else if (itemNameTrimmed === '化粧品') {
                            if (gender) {
                                monthData.gender[gender].products.cosmetics = { amount, count };
                            } else {
                                monthData.products.cosmetics = { amount, count };
                            }
                            foundProductData = true;
                            console.log(`Row ${i}: Added cosmetics:`, { amount, count });
                        }
                    }
                }
            }
            
            console.log('Processed data:', monthData);
            console.log('Found treatment data:', foundTreatmentData);
            console.log('Found product data:', foundProductData);
            
            // 性別データの更新
            if (gender) {
                monthData.gender[gender].amount = monthData.totals.grand.amount;
                monthData.gender[gender].count = monthData.totals.grand.count;
                console.log(`Updated ${gender} data:`, monthData.gender[gender]);
                
                // 男女両方のデータがあるかチェック
                if (monthData.gender.male.count > 0 && monthData.gender.female.count > 0) {
                    monthData.hasBothGenders = true;
                    
                    // 全体の施術・物品データを統合
                    monthData.treatments = {};
                    monthData.products = {
                        external: { amount: 0, count: 0 },
                        internal: { amount: 0, count: 0 },
                        cosmetics: { amount: 0, count: 0 }
                    };
                    
                    // 男女の施術データを統合
                    ['male', 'female'].forEach(g => {
                        Object.entries(monthData.gender[g].treatments || {}).forEach(([name, data]) => {
                            if (!monthData.treatments[name]) {
                                monthData.treatments[name] = { amount: 0, count: 0, avgPrice: 0 };
                            }
                            monthData.treatments[name].amount += data.amount;
                            monthData.treatments[name].count += data.count;
                            monthData.treatments[name].avgPrice = Math.round(monthData.treatments[name].amount / monthData.treatments[name].count);
                        });
                        
                        // 物品データを統合
                        ['external', 'internal', 'cosmetics'].forEach(type => {
                            if (monthData.gender[g].products[type]) {
                                monthData.products[type].amount += monthData.gender[g].products[type].amount;
                                monthData.products[type].count += monthData.gender[g].products[type].count;
                            }
                        });
                    });
                    
                    // 合計を再計算
                    monthData.totals.treatment.amount = monthData.gender.male.amount + monthData.gender.female.amount;
                    monthData.totals.treatment.count = monthData.gender.male.count + monthData.gender.female.count;
                    monthData.totals.product.amount = monthData.products.external.amount + monthData.products.internal.amount + monthData.products.cosmetics.amount;
                    monthData.totals.product.count = monthData.products.external.count + monthData.products.internal.count + monthData.products.cosmetics.count;
                    monthData.totals.grand.amount = monthData.totals.treatment.amount;
                    monthData.totals.grand.count = monthData.totals.treatment.count;
                }
            }
            
            // データ保存
            salesData[formattedMonth] = monthData;
            localStorage.setItem('salesData', JSON.stringify(salesData));
            
            // 表示更新
            currentMonth = formattedMonth;
            updateMonthSelector();
            document.getElementById('monthSelector').value = currentMonth;
            displayData();
            updateChart();
            
            const genderText = gender === 'male' ? '男性' : gender === 'female' ? '女性' : '';
            if (monthData.hasBothGenders) {
                alert(`${formattedMonth}の${genderText}データを読み込みました。\n男女両方のデータが揃いました。`);
            } else {
                alert(`${formattedMonth}の${genderText}データを読み込みました`);
            }
        }

        // 月選択セレクタの更新
        function updateMonthSelector() {
            const selector = document.getElementById('monthSelector');
            const months = Object.keys(salesData).sort();
            
            selector.innerHTML = '<option value="">月を選択</option>';
            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = month;
                selector.appendChild(option);
            });
        }

        // 月変更処理
        function handleMonthChange(event) {
            currentMonth = event.target.value;
            if (currentMonth) {
                if (currentTab === 'selfPay' && salesData[currentMonth]) {
                    displayData();
                } else if (currentTab === 'insurance' && insuranceData[currentMonth]) {
                    displayInsuranceData();
                } else {
                    // データがない場合
                    document.getElementById('selfPayContent').classList.add('hidden');
                    document.getElementById('insuranceContent').classList.add('hidden');
                    document.getElementById('emptyState').classList.remove('hidden');
                }
            } else {
                document.getElementById('selfPayContent').classList.add('hidden');
                document.getElementById('insuranceContent').classList.add('hidden');
                document.getElementById('emptyState').classList.remove('hidden');
            }
        }

        // データ表示
        function displayData() {
            if (!currentMonth || !salesData[currentMonth]) return;
            
            document.getElementById('selfPayContent').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            
            const data = salesData[currentMonth];
            
            // 総売上サマリー表示
            displaySummary(data);
            
            // 施術ランキング表示
            displayTreatmentRanking(data.treatments);
            
            // 物品サマリー表示
            displayProductSummary(data.products);
            
            // 男女比率表示（データがある場合）
            displayGenderRatio(data.gender);
            
            // グラフ更新（複数月のデータがある場合）
            if (Object.keys(salesData).length > 0) {
                updateChart();
            }
        }

        // 総売上サマリー表示
        function displaySummary(data) {
            // 金額フォーマット
            const formatAmount = (amount) => '¥' + amount.toLocaleString();
            
            // 前月データ取得
            const months = Object.keys(salesData).sort();
            const currentIndex = months.indexOf(currentMonth);
            const previousMonth = currentIndex > 0 ? months[currentIndex - 1] : null;
            const previousData = previousMonth ? salesData[previousMonth] : null;
            
            // 比較計算（金額用）
            const calculateComparison = (current, previous) => {
                if (!previous || previous === 0) return '<span class="text-gray-400">前月データなし</span>';
                const diff = current - previous;
                const percent = Math.round((diff / previous) * 100);
                const sign = diff >= 0 ? '+' : '';
                const className = diff >= 0 ? 'comparison-positive' : 'comparison-negative';
                return `<span class="${className}">${sign}${percent}% (${sign}${formatAmount(diff)})</span>`;
            };
            
            // 比較計算（件数用）
            const calculateCountComparison = (current, previous) => {
                if (!previous || previous === 0) return '<span class="text-gray-400">-</span>';
                const diff = current - previous;
                const percent = Math.round((diff / previous) * 100);
                const sign = diff >= 0 ? '+' : '';
                const className = diff >= 0 ? 'comparison-positive' : 'comparison-negative';
                return `<span class="${className}">${sign}${percent}%</span>`;
            };
            
            // 施術売上
            document.getElementById('treatmentTotal').textContent = formatAmount(data.totals.treatment.amount);
            document.getElementById('treatmentComparison').innerHTML = previousData ? 
                calculateComparison(data.totals.treatment.amount, previousData.totals.treatment.amount) : 
                '<span class="text-gray-400">前月データなし</span>';
            document.getElementById('treatmentCount').textContent = data.totals.treatment.count.toLocaleString() + '件';
            document.getElementById('treatmentCountComparison').innerHTML = previousData ? 
                calculateCountComparison(data.totals.treatment.count, previousData.totals.treatment.count) : 
                '<span class="text-gray-400">-</span>';
            
            // 物品売上
            document.getElementById('productTotal').textContent = formatAmount(data.totals.product.amount);
            document.getElementById('productComparison').innerHTML = previousData ? 
                calculateComparison(data.totals.product.amount, previousData.totals.product.amount) : 
                '<span class="text-gray-400">前月データなし</span>';
            document.getElementById('productCount').textContent = data.totals.product.count.toLocaleString() + '件';
            document.getElementById('productCountComparison').innerHTML = previousData ? 
                calculateCountComparison(data.totals.product.count, previousData.totals.product.count) : 
                '<span class="text-gray-400">-</span>';
            
            // 総売上
            document.getElementById('grandTotal').textContent = formatAmount(data.totals.grand.amount);
            document.getElementById('grandComparison').innerHTML = previousData ? 
                calculateComparison(data.totals.grand.amount, previousData.totals.grand.amount) : 
                '<span class="text-gray-400">前月データなし</span>';
            document.getElementById('grandCount').textContent = data.totals.grand.count.toLocaleString() + '件';
            document.getElementById('grandCountComparison').innerHTML = previousData ? 
                calculateCountComparison(data.totals.grand.count, previousData.totals.grand.count) : 
                '<span class="text-gray-400">-</span>';
        }

        // 施術ランキング表示
        function displayTreatmentRanking(treatments) {
            console.log('Displaying treatment ranking:', treatments);
            console.log('Treatment keys:', Object.keys(treatments));
            console.log('Treatment count:', Object.keys(treatments).length);
            
            if (!treatments || Object.keys(treatments).length === 0) {
                document.getElementById('treatmentRanking').innerHTML = '<p class="text-gray-500">施術データがありません</p>';
                return;
            }
            
            const currentData = salesData[currentMonth];
            const hasBothGenders = currentData && currentData.hasBothGenders;
            
            const sortedTreatments = Object.entries(treatments).sort((a, b) => {
                if (rankingMode === 'amount') {
                    return b[1].amount - a[1].amount;
                } else {
                    return b[1].count - a[1].count;
                }
            });
            
            let html = `
                <table class="w-full">
                    <thead>
                        <tr class="border-b">
                            <th class="text-left py-2 px-1 w-12">順位</th>
                            <th class="text-left py-2 px-2">施術名</th>
                            <th class="text-right py-2 px-2">売上金額</th>
                            <th class="text-right py-2 px-2">前月比</th>
                            <th class="text-right py-2 px-2">件数</th>
                            <th class="text-right py-2 px-2">平均単価</th>
                            ${hasBothGenders ? '<th class="text-center py-2 px-2">男女比</th>' : ''}
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // 前月データ取得
            const months = Object.keys(salesData).sort();
            const currentIndex = months.indexOf(currentMonth);
            const previousMonth = currentIndex > 0 ? months[currentIndex - 1] : null;
            const previousData = previousMonth ? salesData[previousMonth].treatments : null;
            
            sortedTreatments.forEach((item, index) => {
                const [name, data] = item;
                const rankClass = index < 3 ? `rank-${index + 1}` : '';
                
                // 前月比計算
                let changeDisplay = '<span class="text-gray-400">-</span>';
                if (previousData && previousData[name]) {
                    const prevAmount = previousData[name].amount;
                    const change = data.amount - prevAmount;
                    const changePercent = Math.round((change / prevAmount) * 100);
                    const changeClass = change >= 0 ? 'comparison-positive' : 'comparison-negative';
                    const sign = change >= 0 ? '+' : '';
                    changeDisplay = `<span class="${changeClass}">${sign}${changePercent}%</span>`;
                }
                
                // 男女比の計算
                let genderRatioDisplay = '';
                if (hasBothGenders) {
                    const maleCount = currentData.gender.male.treatments[name]?.count || 0;
                    const femaleCount = currentData.gender.female.treatments[name]?.count || 0;
                    const totalCount = maleCount + femaleCount;
                    
                    if (totalCount > 0) {
                        const maleRatio = Math.round((maleCount / totalCount) * 100);
                        const femaleRatio = Math.round((femaleCount / totalCount) * 100);
                        genderRatioDisplay = `
                            <div class="flex items-center justify-center gap-2 text-xs">
                                <span class="text-blue-600 font-medium">男${maleRatio}%</span>
                                <span class="text-gray-400">:</span>
                                <span class="text-pink-600 font-medium">女${femaleRatio}%</span>
                            </div>
                        `;
                    } else {
                        genderRatioDisplay = '<span class="text-gray-400 text-xs">-</span>';
                    }
                }
                
                html += `
                    <tr class="border-b ${rankClass} fade-in">
                        <td class="py-3 px-1">${index + 1}</td>
                        <td class="py-3 px-2"><span class="treatment-name" onclick="showTreatmentDetail('${name.replace(/'/g, "\\'")}')">${name}</span></td>
                        <td class="text-right py-3 px-2 font-semibold">¥${data.amount.toLocaleString()}</td>
                        <td class="text-right py-3 px-2">${changeDisplay}</td>
                        <td class="text-right py-3 px-2">${data.count.toLocaleString()}件</td>
                        <td class="text-right py-3 px-2">¥${data.avgPrice.toLocaleString()}</td>
                        ${hasBothGenders ? `<td class="text-center py-3 px-2">${genderRatioDisplay}</td>` : ''}
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            document.getElementById('treatmentRanking').innerHTML = html;
        }

        // 物品サマリー表示
        function displayProductSummary(products) {
            const formatAmount = (amount) => '¥' + amount.toLocaleString();
            
            // 前月データ取得
            const months = Object.keys(salesData).sort();
            const currentIndex = months.indexOf(currentMonth);
            const previousMonth = currentIndex > 0 ? months[currentIndex - 1] : null;
            const previousProducts = previousMonth ? salesData[previousMonth].products : null;
            
            // 比較表示
            const showComparison = (current, previous) => {
                if (!previous || previous.amount === 0) return '前月データなし';
                const diff = current.amount - previous.amount;
                const percent = Math.round((diff / previous.amount) * 100);
                const sign = diff >= 0 ? '+' : '';
                const className = diff >= 0 ? 'comparison-positive' : 'comparison-negative';
                return `<span class="${className}">前月比: ${sign}${percent}%</span>`;
            };
            
            // 外用薬
            document.getElementById('externalMedicine').textContent = formatAmount(products.external.amount);
            document.getElementById('externalComparison').innerHTML = previousProducts ? 
                showComparison(products.external, previousProducts.external) : '前月データなし';
            
            // 内服薬
            document.getElementById('internalMedicine').textContent = formatAmount(products.internal.amount);
            document.getElementById('internalComparison').innerHTML = previousProducts ? 
                showComparison(products.internal, previousProducts.internal) : '前月データなし';
            
            // 化粧品
            document.getElementById('cosmetics').textContent = formatAmount(products.cosmetics.amount);
            document.getElementById('cosmeticsComparison').innerHTML = previousProducts ? 
                showComparison(products.cosmetics, previousProducts.cosmetics) : '前月データなし';
        }

        // グラフ更新
        function updateChart() {
            const ctx = document.getElementById('salesChart').getContext('2d');
            const allMonths = Object.keys(salesData).sort();
            
            // 期間に応じて表示する月を決定
            let displayMonths;
            if (chartPeriod === 'all') {
                displayMonths = allMonths;
            } else if (chartPeriod === 'custom') {
                // カスタム期間の処理は後で実装
                displayMonths = allMonths;
            } else {
                const periodNum = parseInt(chartPeriod);
                displayMonths = allMonths.slice(-periodNum);
            }
            
            const chartData = {
                labels: displayMonths,
                datasets: [
                    {
                        label: '施術売上',
                        data: displayMonths.map(month => salesData[month].totals.treatment.amount),
                        backgroundColor: 'rgba(59, 130, 246, 0.8)',
                        borderColor: 'rgb(59, 130, 246)',
                        borderWidth: 1,
                        yAxisID: 'y-amount',
                        order: 2
                    },
                    {
                        label: '物品売上',
                        data: displayMonths.map(month => salesData[month].totals.product.amount),
                        backgroundColor: 'rgba(251, 146, 60, 0.8)',
                        borderColor: 'rgb(251, 146, 60)',
                        borderWidth: 1,
                        yAxisID: 'y-amount',
                        order: 2
                    },
                    {
                        label: '施術件数',
                        data: displayMonths.map(month => salesData[month].totals.treatment.count),
                        type: 'line',
                        borderColor: 'rgb(34, 197, 94)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        borderWidth: 2,
                        yAxisID: 'y-count',
                        tension: 0.1,
                        order: 1
                    },
                    {
                        label: '物品件数',
                        data: displayMonths.map(month => salesData[month].totals.product.count),
                        type: 'line',
                        borderColor: 'rgb(168, 85, 247)',
                        backgroundColor: 'rgba(168, 85, 247, 0.1)',
                        borderWidth: 2,
                        yAxisID: 'y-count',
                        tension: 0.1,
                        order: 1
                    }
                ]
            };

            if (salesChart) {
                salesChart.destroy();
            }

            salesChart = new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.dataset.yAxisID === 'y-amount') {
                                        label += '¥' + context.parsed.y.toLocaleString();
                                    } else {
                                        label += context.parsed.y + '件';
                                    }
                                    return label;
                                },
                                afterLabel: function(context) {
                                    const monthData = salesData[context.label];
                                    if (monthData && context.dataset.yAxisID === 'y-amount') {
                                        const total = monthData.totals.grand.amount;
                                        const percentage = Math.round((context.parsed.y / total) * 100);
                                        return `総売上の${percentage}%`;
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true
                        },
                        'y-amount': {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '¥' + value.toLocaleString();
                                }
                            },
                            title: {
                                display: true,
                                text: '売上金額'
                            }
                        },
                        'y-count': {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            grid: {
                                drawOnChartArea: false,
                            },
                            title: {
                                display: true,
                                text: '件数'
                            }
                        }
                    }
                }
            });
        }

        // ランキング切り替え
        function showRanking(mode) {
            rankingMode = mode;
            showPieChart = false;
            
            // ボタンスタイル切り替え
            const amountBtn = document.getElementById('amountBtn');
            const countBtn = document.getElementById('countBtn');
            const chartBtn = document.getElementById('chartBtn');
            
            if (mode === 'amount') {
                amountBtn.className = 'px-4 py-2 bg-blue-600 text-white rounded-lg text-sm';
                countBtn.className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm';
            } else {
                amountBtn.className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm';
                countBtn.className = 'px-4 py-2 bg-blue-600 text-white rounded-lg text-sm';
            }
            chartBtn.className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm';
            
            // 表示切り替え
            document.getElementById('treatmentRanking').classList.remove('hidden');
            document.getElementById('pieChartContainer').classList.add('hidden');
            
            // ランキング再表示
            if (currentMonth && salesData[currentMonth]) {
                displayTreatmentRanking(salesData[currentMonth].treatments);
            }
        }
        
        // 円グラフ表示切り替え
        function toggleChartView() {
            showPieChart = !showPieChart;
            const chartBtn = document.getElementById('chartBtn');
            
            if (showPieChart) {
                chartBtn.className = 'px-4 py-2 bg-blue-600 text-white rounded-lg text-sm';
                document.getElementById('treatmentRanking').classList.add('hidden');
                document.getElementById('pieChartContainer').classList.remove('hidden');
                displayPieChart();
            } else {
                chartBtn.className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm';
                document.getElementById('treatmentRanking').classList.remove('hidden');
                document.getElementById('pieChartContainer').classList.add('hidden');
            }
        }
        
        // 円グラフ表示
        function displayPieChart() {
            if (!currentMonth || !salesData[currentMonth]) return;
            
            const treatments = salesData[currentMonth].treatments;
            console.log('Pie chart - treatments:', treatments);
            
            const sortedTreatments = Object.entries(treatments)
                .filter(([name, data]) => name && name !== 'undefined' && data && data.amount > 0)
                .sort((a, b) => {
                    return rankingMode === 'amount' ? b[1].amount - a[1].amount : b[1].count - a[1].count;
                });
            
            console.log('Pie chart - sortedTreatments:', sortedTreatments);
            
            // 上位10件を取得、残りは「その他」にまとめる
            const topTreatments = sortedTreatments.slice(0, 10);
            const otherTreatments = sortedTreatments.slice(10);
            
            const labels = [];
            const data = [];
            
            topTreatments.forEach(([name, treatmentData]) => {
                console.log('Processing treatment for pie chart:', name, treatmentData);
                if (name && name !== 'undefined' && name.trim() !== '') {
                    labels.push(name);
                    data.push(rankingMode === 'amount' ? treatmentData.amount : treatmentData.count);
                }
            });
            
            console.log('Pie chart labels:', labels);
            console.log('Pie chart data:', data);
            
            if (otherTreatments.length > 0) {
                const otherValue = otherTreatments.reduce((sum, [, data]) => {
                    return sum + (rankingMode === 'amount' ? data.amount : data.count);
                }, 0);
                labels.push('その他');
                data.push(otherValue);
            }
            
            const ctx = document.getElementById('treatmentPieChart').getContext('2d');
            
            if (pieChart) {
                pieChart.destroy();
            }
            
            pieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(251, 146, 60, 0.8)',
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(168, 85, 247, 0.8)',
                            'rgba(236, 72, 153, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(6, 182, 212, 0.8)',
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(84, 56, 255, 0.8)',
                            'rgba(52, 211, 153, 0.8)',
                            'rgba(156, 163, 175, 0.8)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                padding: 15,
                                usePointStyle: true,
                                pointStyle: 'rectRounded',
                                font: {
                                    size: 12
                                },
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (!data.labels || !data.datasets || !data.datasets[0]) {
                                        return [];
                                    }
                                    
                                    return data.labels.map((label, index) => {
                                        const value = data.datasets[0].data[index];
                                        const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((value / total) * 100);
                                        
                                        let text = label || 'unknown';
                                        if (rankingMode === 'amount') {
                                            text = `${text}: ¥${value.toLocaleString()} (${percentage}%)`;
                                        } else {
                                            text = `${text}: ${value}件 (${percentage}%)`;
                                        }
                                        
                                        return {
                                            text: text,
                                            fillStyle: data.datasets[0].backgroundColor[index],
                                            hidden: false,
                                            index: index
                                        };
                                    });
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    
                                    if (rankingMode === 'amount') {
                                        return `${label}: ¥${value.toLocaleString()} (${percentage}%)`;
                                    } else {
                                        return `${label}: ${value}件 (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }

        // 保険データ処理
        function processInsuranceData(data, formattedMonth) {
            console.log('Processing insurance data for:', formattedMonth);
            console.log('Raw data first 500 chars:', data.substring(0, 500));
            
            try {
                const lines = data.split('\n').filter(line => line.trim());
                console.log('Total lines:', lines.length);
                
                // 保険データ構造の初期化
                let monthData = {
                    medicalRevenue: 0,      // 医療収益
                    firstVisitCount: 0,     // 初診件数
                    returnVisitCount: 0,    // 再診件数
                    newPatientCount: 0,     // 新患数
                    totalPatientCount: 0    // 受診者数
                };
                
                // デバッグ用：最初の10行を表示
                console.log('First 10 lines:');
                lines.slice(0, 10).forEach((line, index) => {
                    console.log(`Line ${index}:`, line);
                });
                
                // 各行を処理 - より柔軟な検索方法を使用
                let foundRevenue = false;
                let foundCounts = false;
                
                lines.forEach((line, index) => {
                    const cols = line.split(',');
                    
                    // 「合計」を含む行を探して医療収益を取得
                    if (!foundRevenue && line.includes('合計') && cols.length > 2) {
                        console.log('Found revenue line:', line);
                        console.log('Columns:', cols);
                        
                        // 通常、医療収益は3列目（インデックス2）にある
                        // 保険点数（2列目）と医療収益（3列目）を区別
                        if (cols.length > 2) {
                            // 医療収益（実際の金額）は3列目
                            const revenueStr = cols[2].replace(/[^\d]/g, '');
                            const revenue = parseInt(revenueStr) || 0;
                            
                            // 保険点数（2列目）も確認用に取得
                            const pointsStr = cols[1].replace(/[^\d]/g, '');
                            const points = parseInt(pointsStr) || 0;
                            
                            console.log('保険点数:', points, '医療収益:', revenue);
                            
                            // 医療収益を保存（保険点数の約10倍が医療収益）
                            monthData.medicalRevenue = revenue;
                            foundRevenue = true;
                        }
                    }
                    
                    // 「初診」を含む行を探す
                    if (line.includes('初診') && !line.includes('再診')) {
                        console.log('Found first visit line:', line);
                        for (let i = 1; i < cols.length; i++) {
                            const value = parseInt(cols[i].replace(/[^\d]/g, '')) || 0;
                            if (value > 0 && value < 10000) { // 件数は通常小さめの数値
                                monthData.firstVisitCount = value;
                                console.log('Extracted first visit:', value);
                                break;
                            }
                        }
                    }
                    
                    // 「再診」を含む行を探す
                    if (line.includes('再診') && !line.includes('初診')) {
                        console.log('Found return visit line:', line);
                        for (let i = 1; i < cols.length; i++) {
                            const value = parseInt(cols[i].replace(/[^\d]/g, '')) || 0;
                            if (value > 0 && value < 10000) {
                                monthData.returnVisitCount = value;
                                console.log('Extracted return visit:', value);
                                break;
                            }
                        }
                    }
                    
                    // 「新患」を含む行を探す
                    if (line.includes('新患')) {
                        console.log('Found new patient line:', line);
                        for (let i = 1; i < cols.length; i++) {
                            const value = parseInt(cols[i].replace(/[^\d]/g, '')) || 0;
                            if (value > 0 && value < 10000) {
                                monthData.newPatientCount = value;
                                console.log('Extracted new patient:', value);
                                break;
                            }
                        }
                    }
                    
                    // 「受診者数」を含む行を探す
                    if (line.includes('受診者') || line.includes('実人数')) {
                        console.log('Found total patient line:', line);
                        for (let i = 1; i < cols.length; i++) {
                            const value = parseInt(cols[i].replace(/[^\d]/g, '')) || 0;
                            if (value > 0 && value < 10000) {
                                monthData.totalPatientCount = value;
                                console.log('Extracted total patient:', value);
                                break;
                            }
                        }
                    }
                });
                
                // データが正しく読み込まれたかチェック
                const hasValidData = monthData.medicalRevenue > 0 || 
                                   monthData.firstVisitCount > 0 || 
                                   monthData.returnVisitCount > 0 ||
                                   monthData.newPatientCount > 0 ||
                                   monthData.totalPatientCount > 0;
                
                if (!hasValidData) {
                    console.warn('警告: データが見つかりませんでした。CSVの形式を確認してください。');
                    console.log('期待される形式: 合計行に医療収益（3列目）、初診・再診・新患・受診者数の各行');
                }
                
                // 保険データを保存
                insuranceData[formattedMonth] = monthData;
                localStorage.setItem('insuranceData', JSON.stringify(insuranceData));
                
                console.log('保険データ処理完了:', formattedMonth, monthData);
                
                // 現在の月を更新
                currentMonth = formattedMonth;
                updateMonthSelector();
                document.getElementById('monthSelector').value = currentMonth;
                
                // 保険タブに切り替えて表示
                switchTab('insurance');
                
                // データが正常に読み込まれた場合のみ成功メッセージを表示
                if (hasValidData) {
                    alert(`${formattedMonth}の保険データを読み込みました`);
                }
            } catch (error) {
                console.error('保険データ処理エラー:', error);
                // エラーメッセージは表示しない（データは表示されているため）
            }
        }
        
        // 保険データ表示
        function displayInsuranceData() {
            if (!currentMonth || !insuranceData[currentMonth]) {
                document.getElementById('noInsuranceData').classList.remove('hidden');
                // グラフエリアを非表示
                const chartArea = document.getElementById('insuranceChartArea');
                if (chartArea) {
                    chartArea.classList.add('hidden');
                }
                return;
            }
            
            document.getElementById('noInsuranceData').classList.add('hidden');
            document.getElementById('insuranceContent').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            
            // グラフエリアも表示
            const chartArea = document.getElementById('insuranceChartArea');
            if (chartArea) {
                chartArea.classList.remove('hidden');
            }
            
            const data = insuranceData[currentMonth];
            
            // 金額フォーマット
            const formatAmount = (amount) => '¥' + amount.toLocaleString();
            const formatCount = (count) => count.toLocaleString() + '件';
            const formatPeople = (count) => count.toLocaleString() + '人';
            
            // 各項目の表示
            document.getElementById('medicalRevenue').textContent = formatAmount(data.medicalRevenue);
            document.getElementById('firstVisitCount').textContent = formatCount(data.firstVisitCount);
            document.getElementById('returnVisitCount').textContent = formatCount(data.returnVisitCount);
            document.getElementById('newPatientCount').textContent = formatPeople(data.newPatientCount);
            document.getElementById('totalPatientCount').textContent = formatPeople(data.totalPatientCount);
            
            // 前月比の計算と表示
            displayInsuranceComparison(currentMonth);
            
            // グラフを更新
            updateInsuranceCharts();
        }
        
        // データクリア
        function clearAllData() {
            if (confirm('すべてのデータを削除しますか？')) {
                localStorage.removeItem('salesData');
                localStorage.removeItem('insuranceData');
                salesData = {};
                insuranceData = {};
                currentMonth = '';
                updateMonthSelector();
                document.getElementById('selfPayContent').classList.add('hidden');
                document.getElementById('insuranceContent').classList.add('hidden');
                document.getElementById('emptyState').classList.remove('hidden');
                if (salesChart) {
                    salesChart.destroy();
                    salesChart = null;
                }
                if (pieChart) {
                    pieChart.destroy();
                    pieChart = null;
                }
                alert('データをクリアしました');
            }
        }

        // 施術詳細表示
        function showTreatmentDetail(treatmentName) {
            const modal = document.getElementById('treatmentDetailModal');
            const modalTitle = document.getElementById('modalTitle');
            
            modalTitle.textContent = `${treatmentName}の売上推移`;
            modal.classList.remove('hidden');
            
            // 過去12ヶ月分のデータを取得
            const months = Object.keys(salesData).sort();
            const last12Months = months.slice(-12);
            
            const monthlyData = [];
            const amounts = [];
            const counts = [];
            
            last12Months.forEach(month => {
                const treatment = salesData[month].treatments[treatmentName];
                monthlyData.push(month);
                amounts.push(treatment ? treatment.amount : 0);
                counts.push(treatment ? treatment.count : 0);
            });
            
            // グラフ表示
            const ctx = document.getElementById('treatmentDetailChart').getContext('2d');
            
            if (detailChart) {
                detailChart.destroy();
            }
            
            detailChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: monthlyData,
                    datasets: [{
                        label: '売上金額',
                        data: amounts,
                        backgroundColor: 'rgba(59, 130, 246, 0.8)',
                        borderColor: 'rgb(59, 130, 246)',
                        borderWidth: 1,
                        yAxisID: 'y-amount'
                    }, {
                        label: '件数',
                        data: counts,
                        type: 'line',
                        borderColor: 'rgb(251, 146, 60)',
                        backgroundColor: 'rgba(251, 146, 60, 0.1)',
                        yAxisID: 'y-count',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.dataset.yAxisID === 'y-amount') {
                                        label += '¥' + context.parsed.y.toLocaleString();
                                    } else {
                                        label += context.parsed.y + '件';
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        'y-amount': {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '¥' + value.toLocaleString();
                                }
                            },
                            title: {
                                display: true,
                                text: '売上金額'
                            }
                        },
                        'y-count': {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            grid: {
                                drawOnChartArea: false,
                            },
                            title: {
                                display: true,
                                text: '件数'
                            }
                        }
                    }
                }
            });
            
            // 詳細テーブル作成
            let tableHtml = `
                <table class="w-full mt-4">
                    <thead>
                        <tr class="border-b">
                            <th class="text-left py-2">月</th>
                            <th class="text-right py-2">売上金額</th>
                            <th class="text-right py-2">件数</th>
                            <th class="text-right py-2">平均単価</th>
                            <th class="text-right py-2">前月比</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            last12Months.forEach((month, index) => {
                const treatment = salesData[month].treatments[treatmentName];
                if (treatment) {
                    let changeDisplay = '<span class="text-gray-400">-</span>';
                    if (index > 0) {
                        const prevMonth = last12Months[index - 1];
                        const prevTreatment = salesData[prevMonth].treatments[treatmentName];
                        if (prevTreatment && prevTreatment.amount > 0) {
                            const change = treatment.amount - prevTreatment.amount;
                            const changePercent = Math.round((change / prevTreatment.amount) * 100);
                            const changeClass = change >= 0 ? 'comparison-positive' : 'comparison-negative';
                            const sign = change >= 0 ? '+' : '';
                            changeDisplay = `<span class="${changeClass}">${sign}${changePercent}%</span>`;
                        }
                    }
                    
                    tableHtml += `
                        <tr class="border-b">
                            <td class="py-2">${month}</td>
                            <td class="text-right py-2">¥${treatment.amount.toLocaleString()}</td>
                            <td class="text-right py-2">${treatment.count}件</td>
                            <td class="text-right py-2">¥${treatment.avgPrice.toLocaleString()}</td>
                            <td class="text-right py-2">${changeDisplay}</td>
                        </tr>
                    `;
                }
            });
            
            tableHtml += '</tbody></table>';
            document.getElementById('treatmentDetailTable').innerHTML = tableHtml;
            
            // 男女比率グラフの表示（男女別データがある場合）
            const currentData = salesData[currentMonth];
            if (currentData && currentData.hasBothGenders) {
                document.getElementById('treatmentGenderChart').classList.remove('hidden');
                
                const maleData = currentData.gender.male.treatments[treatmentName];
                const femaleData = currentData.gender.female.treatments[treatmentName];
                
                if (maleData || femaleData) {
                    const maleCount = maleData?.count || 0;
                    const femaleCount = femaleData?.count || 0;
                    
                    const ctx = document.getElementById('treatmentGenderRatioChart').getContext('2d');
                    
                    if (treatmentGenderChart) {
                        treatmentGenderChart.destroy();
                    }
                    
                    treatmentGenderChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['男性', '女性'],
                            datasets: [{
                                data: [maleCount, femaleCount],
                                backgroundColor: [
                                    'rgba(59, 130, 246, 0.8)',  // 青
                                    'rgba(236, 72, 153, 0.8)'   // ピンク
                                ],
                                borderColor: [
                                    'rgb(59, 130, 246)',
                                    'rgb(236, 72, 153)'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        padding: 15,
                                        usePointStyle: true,
                                        pointStyle: 'rectRounded',
                                        font: {
                                            size: 14
                                        },
                                        generateLabels: function(chart) {
                                            const data = chart.data;
                                            return data.labels.map((label, index) => {
                                                const value = data.datasets[0].data[index];
                                                const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                                const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                                
                                                return {
                                                    text: `${label}: ${value.toLocaleString()}件 (${percentage}%)`,
                                                    fillStyle: data.datasets[0].backgroundColor[index],
                                                    hidden: false,
                                                    index: index
                                                };
                                            });
                                        }
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.parsed;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                            
                                            return `${label}: ${value.toLocaleString()}件 (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            } else {
                document.getElementById('treatmentGenderChart').classList.add('hidden');
            }
        }
        
        // 保険データのグラフを更新
        function updateInsuranceCharts() {
            console.log('updateInsuranceCharts called');
            console.log('insuranceData:', insuranceData);
            
            const months = Object.keys(insuranceData).sort();
            console.log('months:', months);
            
            // データが無い場合は終了
            if (months.length === 0) {
                console.log('No data for charts');
                return;
            }
            
            // グラフデータを準備
            const revenueData = months.map(month => insuranceData[month].medicalRevenue);
            const patientData = months.map(month => insuranceData[month].totalPatientCount);
            console.log('revenueData:', revenueData);
            console.log('patientData:', patientData);
            
            // canvasが存在するか確認
            const revenueCanvas = document.getElementById('insuranceRevenueChart');
            const patientCanvas = document.getElementById('insurancePatientChart');
            
            if (!revenueCanvas || !patientCanvas) {
                console.error('Canvas elements not found');
                return;
            }
            
            // 医療収益推移グラフ
            const revenueCtx = revenueCanvas.getContext('2d');
            if (window.insuranceRevenueChart) {
                window.insuranceRevenueChart.destroy();
            }
            window.insuranceRevenueChart = new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: '医療収益',
                        data: revenueData,
                        borderColor: 'rgb(34, 197, 94)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '医療収益: ¥' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '¥' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
            
            // 受診者数推移グラフ
            const patientCtx = document.getElementById('insurancePatientChart').getContext('2d');
            if (window.insurancePatientChart) {
                window.insurancePatientChart.destroy();
            }
            window.insurancePatientChart = new Chart(patientCtx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: '受診者数',
                        data: patientData,
                        backgroundColor: 'rgba(59, 130, 246, 0.8)',
                        borderColor: 'rgb(59, 130, 246)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '受診者数: ' + context.parsed.y.toLocaleString() + '人';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + '人';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // 保険データの前月比を表示
        function displayInsuranceComparison(month) {
            const months = Object.keys(insuranceData).sort();
            const currentIndex = months.indexOf(month);
            
            // 前月のデータがない場合は何も表示しない
            if (currentIndex <= 0) {
                document.getElementById('medicalRevenueComparison').textContent = '';
                document.getElementById('firstVisitCountComparison').textContent = '';
                document.getElementById('returnVisitCountComparison').textContent = '';
                document.getElementById('newPatientCountComparison').textContent = '';
                document.getElementById('totalPatientCountComparison').textContent = '';
                return;
            }
            
            const previousMonth = months[currentIndex - 1];
            const currentData = insuranceData[month];
            const previousData = insuranceData[previousMonth];
            
            // 前月比を計算して表示
            const calculateComparison = (current, previous) => {
                if (previous === 0) return { text: '-', class: 'text-gray-500' };
                const diff = current - previous;
                const percentage = Math.round((diff / previous) * 100);
                if (diff > 0) {
                    return { text: `+${percentage}%`, class: 'text-green-600' };
                } else if (diff < 0) {
                    return { text: `${percentage}%`, class: 'text-red-600' };
                } else {
                    return { text: '±0%', class: 'text-gray-500' };
                }
            };
            
            // 医療収益
            const revenueComp = calculateComparison(currentData.medicalRevenue, previousData.medicalRevenue);
            const revenueEl = document.getElementById('medicalRevenueComparison');
            revenueEl.textContent = `前月比 ${revenueComp.text}`;
            revenueEl.className = `text-sm mt-1 ${revenueComp.class}`;
            
            // 初診件数
            const firstVisitComp = calculateComparison(currentData.firstVisitCount, previousData.firstVisitCount);
            const firstVisitEl = document.getElementById('firstVisitCountComparison');
            firstVisitEl.textContent = `前月比 ${firstVisitComp.text}`;
            firstVisitEl.className = `text-sm mt-1 ${firstVisitComp.class}`;
            
            // 再診件数
            const returnVisitComp = calculateComparison(currentData.returnVisitCount, previousData.returnVisitCount);
            const returnVisitEl = document.getElementById('returnVisitCountComparison');
            returnVisitEl.textContent = `前月比 ${returnVisitComp.text}`;
            returnVisitEl.className = `text-sm mt-1 ${returnVisitComp.class}`;
            
            // 新患数
            const newPatientComp = calculateComparison(currentData.newPatientCount, previousData.newPatientCount);
            const newPatientEl = document.getElementById('newPatientCountComparison');
            newPatientEl.textContent = `前月比 ${newPatientComp.text}`;
            newPatientEl.className = `text-sm mt-1 ${newPatientComp.class}`;
            
            // 受診者数
            const totalPatientComp = calculateComparison(currentData.totalPatientCount, previousData.totalPatientCount);
            const totalPatientEl = document.getElementById('totalPatientCountComparison');
            totalPatientEl.textContent = `前月比 ${totalPatientComp.text}`;
            totalPatientEl.className = `text-sm mt-1 ${totalPatientComp.class}`;
        }
        
        // モーダルを閉じる
        function closeModal() {
            document.getElementById('treatmentDetailModal').classList.add('hidden');
            if (detailChart) {
                detailChart.destroy();
                detailChart = null;
            }
            if (treatmentGenderChart) {
                treatmentGenderChart.destroy();
                treatmentGenderChart = null;
            }
        }
        
        // モーダル外側クリックで閉じる
        document.getElementById('treatmentDetailModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
        
        // 期間選択変更ハンドラー
        function handleChartPeriodChange(event) {
            chartPeriod = event.target.value;
            const customPeriodDiv = document.getElementById('customPeriod');
            
            if (chartPeriod === 'custom') {
                customPeriodDiv.classList.remove('hidden');
                customPeriodDiv.classList.add('flex');
                updateMonthSelectors();
            } else {
                customPeriodDiv.classList.add('hidden');
                customPeriodDiv.classList.remove('flex');
                updateChart();
            }
        }
        
        // 月選択セレクタを更新
        function updateMonthSelectors() {
            const months = Object.keys(salesData).sort();
            const startMonthSelect = document.getElementById('startMonth');
            const endMonthSelect = document.getElementById('endMonth');
            
            startMonthSelect.innerHTML = '<option value="">開始月</option>';
            endMonthSelect.innerHTML = '<option value="">終了月</option>';
            
            months.forEach(month => {
                startMonthSelect.innerHTML += `<option value="${month}">${month}</option>`;
                endMonthSelect.innerHTML += `<option value="${month}">${month}</option>`;
            });
        }
        
        // カスタム期間を適用
        function applyCustomPeriod() {
            const startMonth = document.getElementById('startMonth').value;
            const endMonth = document.getElementById('endMonth').value;
            
            if (!startMonth || !endMonth) {
                alert('開始月と終了月を選択してください');
                return;
            }
            
            const months = Object.keys(salesData).sort();
            const startIndex = months.indexOf(startMonth);
            const endIndex = months.indexOf(endMonth);
            
            if (startIndex > endIndex) {
                alert('開始月は終了月より前の日付を選択してください');
                return;
            }
            
            updateChartWithCustomPeriod(startMonth, endMonth);
        }
        
        // カスタム期間でグラフを更新
        function updateChartWithCustomPeriod(startMonth, endMonth) {
            const ctx = document.getElementById('salesChart').getContext('2d');
            const allMonths = Object.keys(salesData).sort();
            const startIndex = allMonths.indexOf(startMonth);
            const endIndex = allMonths.indexOf(endMonth);
            const displayMonths = allMonths.slice(startIndex, endIndex + 1);
            
            const chartData = {
                labels: displayMonths,
                datasets: [
                    {
                        label: '施術売上',
                        data: displayMonths.map(month => salesData[month].totals.treatment.amount),
                        backgroundColor: 'rgba(59, 130, 246, 0.8)',
                        borderColor: 'rgb(59, 130, 246)',
                        borderWidth: 1,
                        yAxisID: 'y-amount',
                        order: 2
                    },
                    {
                        label: '物品売上',
                        data: displayMonths.map(month => salesData[month].totals.product.amount),
                        backgroundColor: 'rgba(251, 146, 60, 0.8)',
                        borderColor: 'rgb(251, 146, 60)',
                        borderWidth: 1,
                        yAxisID: 'y-amount',
                        order: 2
                    },
                    {
                        label: '施術件数',
                        data: displayMonths.map(month => salesData[month].totals.treatment.count),
                        type: 'line',
                        borderColor: 'rgb(34, 197, 94)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        borderWidth: 2,
                        yAxisID: 'y-count',
                        tension: 0.1,
                        order: 1
                    },
                    {
                        label: '物品件数',
                        data: displayMonths.map(month => salesData[month].totals.product.count),
                        type: 'line',
                        borderColor: 'rgb(168, 85, 247)',
                        backgroundColor: 'rgba(168, 85, 247, 0.1)',
                        borderWidth: 2,
                        yAxisID: 'y-count',
                        tension: 0.1,
                        order: 1
                    }
                ]
            };

            if (salesChart) {
                salesChart.destroy();
            }

            salesChart = new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.dataset.yAxisID === 'y-amount') {
                                        label += '¥' + context.parsed.y.toLocaleString();
                                    } else {
                                        label += context.parsed.y + '件';
                                    }
                                    return label;
                                },
                                afterLabel: function(context) {
                                    const monthData = salesData[context.label];
                                    if (monthData && context.dataset.yAxisID === 'y-amount') {
                                        const total = monthData.totals.grand.amount;
                                        const percentage = Math.round((context.parsed.y / total) * 100);
                                        return `総売上の${percentage}%`;
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true
                        },
                        'y-amount': {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '¥' + value.toLocaleString();
                                }
                            },
                            title: {
                                display: true,
                                text: '売上金額'
                            }
                        },
                        'y-count': {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            grid: {
                                drawOnChartArea: false,
                            },
                            title: {
                                display: true,
                                text: '件数'
                            }
                        }
                    }
                }
            });
        }
        
        // セクションの折りたたみ切り替え
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const icon = document.getElementById(sectionId + 'Icon');
            
            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                icon.classList.add('rotate-180');
            } else {
                section.classList.add('hidden');
                icon.classList.remove('rotate-180');
            }
        }
        
        // 物品詳細表示
        function showProductDetail(productType) {
            const modal = document.getElementById('productDetailModal');
            const modalTitle = document.getElementById('productModalTitle');
            
            const titles = {
                external: '外用薬',
                internal: '内服薬',
                cosmetics: '化粧品'
            };
            
            modalTitle.textContent = `${titles[productType]}の売上推移`;
            modal.classList.remove('hidden');
            
            // 過去12ヶ月分のデータを取得
            const months = Object.keys(salesData).sort();
            const last12Months = months.slice(-12);
            
            const monthlyData = [];
            const amounts = [];
            const counts = [];
            
            last12Months.forEach(month => {
                const product = salesData[month].products[productType];
                monthlyData.push(month);
                amounts.push(product ? product.amount : 0);
                counts.push(product ? product.count : 0);
            });
            
            // グラフ表示
            const ctx = document.getElementById('productDetailChart').getContext('2d');
            
            if (productChart) {
                productChart.destroy();
            }
            
            productChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: monthlyData,
                    datasets: [{
                        label: '売上金額',
                        data: amounts,
                        backgroundColor: 'rgba(251, 146, 60, 0.8)',
                        borderColor: 'rgb(251, 146, 60)',
                        borderWidth: 1,
                        yAxisID: 'y-amount'
                    }, {
                        label: '件数',
                        data: counts,
                        type: 'line',
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        yAxisID: 'y-count',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.dataset.yAxisID === 'y-amount') {
                                        label += '¥' + context.parsed.y.toLocaleString();
                                    } else {
                                        label += context.parsed.y + '件';
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        'y-amount': {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '¥' + value.toLocaleString();
                                }
                            },
                            title: {
                                display: true,
                                text: '売上金額'
                            }
                        },
                        'y-count': {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            grid: {
                                drawOnChartArea: false,
                            },
                            title: {
                                display: true,
                                text: '件数'
                            }
                        }
                    }
                }
            });
            
            // 詳細テーブル作成
            let tableHtml = `
                <table class="w-full mt-4">
                    <thead>
                        <tr class="border-b">
                            <th class="text-left py-2">月</th>
                            <th class="text-right py-2">売上金額</th>
                            <th class="text-right py-2">件数</th>
                            <th class="text-right py-2">前月比</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            last12Months.forEach((month, index) => {
                const product = salesData[month].products[productType];
                if (product) {
                    let changeDisplay = '<span class="text-gray-400">-</span>';
                    if (index > 0) {
                        const prevMonth = last12Months[index - 1];
                        const prevProduct = salesData[prevMonth].products[productType];
                        if (prevProduct && prevProduct.amount > 0) {
                            const change = product.amount - prevProduct.amount;
                            const changePercent = Math.round((change / prevProduct.amount) * 100);
                            const changeClass = change >= 0 ? 'comparison-positive' : 'comparison-negative';
                            const sign = change >= 0 ? '+' : '';
                            changeDisplay = `<span class="${changeClass}">${sign}${changePercent}%</span>`;
                        }
                    }
                    
                    tableHtml += `
                        <tr class="border-b">
                            <td class="py-2">${month}</td>
                            <td class="text-right py-2">¥${product.amount.toLocaleString()}</td>
                            <td class="text-right py-2">${product.count}件</td>
                            <td class="text-right py-2">${changeDisplay}</td>
                        </tr>
                    `;
                }
            });
            
            tableHtml += '</tbody></table>';
            document.getElementById('productDetailTable').innerHTML = tableHtml;
        }
        
        // 物品モーダルを閉じる
        function closeProductModal() {
            document.getElementById('productDetailModal').classList.add('hidden');
            if (productChart) {
                productChart.destroy();
                productChart = null;
            }
        }
        
        // 物品モーダル外側クリックで閉じる
        document.getElementById('productDetailModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeProductModal();
            }
        });
        
        // 男女比率表示
        function displayGenderRatio(genderData) {
            if (!genderData || (genderData.male.count === 0 && genderData.female.count === 0)) {
                document.getElementById('genderRatioSection').classList.add('hidden');
                return;
            }
            
            document.getElementById('genderRatioSection').classList.remove('hidden');
            
            const maleCount = genderData.male.count;
            const femaleCount = genderData.female.count;
            const totalCount = maleCount + femaleCount;
            
            const maleRatio = totalCount > 0 ? Math.round((maleCount / totalCount) * 100) : 0;
            const femaleRatio = totalCount > 0 ? Math.round((femaleCount / totalCount) * 100) : 0;
            
            // 人数と比率の表示
            document.getElementById('maleCount').textContent = maleCount.toLocaleString() + '人';
            document.getElementById('maleRatio').textContent = `(${maleRatio}%)`;
            document.getElementById('femaleCount').textContent = femaleCount.toLocaleString() + '人';
            document.getElementById('femaleRatio').textContent = `(${femaleRatio}%)`;
            document.getElementById('totalGenderCount').textContent = totalCount.toLocaleString() + '人';
            
            // 円グラフの表示
            const ctx = document.getElementById('genderChart').getContext('2d');
            
            if (genderChart) {
                genderChart.destroy();
            }
            
            genderChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['男性', '女性'],
                    datasets: [{
                        data: [maleCount, femaleCount],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',  // 青
                            'rgba(236, 72, 153, 0.8)'   // ピンク
                        ],
                        borderColor: [
                            'rgb(59, 130, 246)',
                            'rgb(236, 72, 153)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                usePointStyle: true,
                                pointStyle: 'rectRounded',
                                font: {
                                    size: 14
                                },
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    return data.labels.map((label, index) => {
                                        const value = data.datasets[0].data[index];
                                        const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((value / total) * 100);
                                        
                                        return {
                                            text: `${label}: ${value.toLocaleString()}人 (${percentage}%)`,
                                            fillStyle: data.datasets[0].backgroundColor[index],
                                            hidden: false,
                                            index: index
                                        };
                                    });
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    
                                    return `${label}: ${value.toLocaleString()}人 (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // デバッグ情報表示
        function showDebugInfo() {
            console.log('Current salesData:', salesData);
            console.log('Current month:', currentMonth);
            if (currentMonth && salesData[currentMonth]) {
                console.log('Current month data:', salesData[currentMonth]);
                console.log('Treatments count:', Object.keys(salesData[currentMonth].treatments).length);
                console.log('Treatments:', salesData[currentMonth].treatments);
                console.log('Products:', salesData[currentMonth].products);
                console.log('Gender:', salesData[currentMonth].gender);
            }
            alert('デバッグ情報をコンソールに出力しました（F12キーで開発者ツールを開いて確認）');
        }
    </script>
</body>
</html>