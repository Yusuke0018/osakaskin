<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>売上分析ダッシュボード</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .comparison-positive { color: #10b981; }
        .comparison-negative { color: #ef4444; }
        .rank-1 { background-color: #fef3c7; }
        .rank-2 { background-color: #e5e7eb; }
        .rank-3 { background-color: #fed7aa; }
        .treatment-name { cursor: pointer; }
        .treatment-name:hover { color: #2563eb; text-decoration: underline; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <!-- ヘッダー -->
        <header class="bg-white rounded-lg shadow-sm p-4 mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                <h1 class="text-2xl font-bold text-gray-800">売上分析ダッシュボード</h1>
                <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                    <!-- 月選択 -->
                    <select id="monthSelector" class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">月を選択</option>
                    </select>
                    <!-- CSVアップロード -->
                    <label class="px-4 py-2 bg-blue-600 text-white rounded-lg cursor-pointer hover:bg-blue-700 transition text-center">
                        CSVアップロード
                        <input type="file" id="csvFile" accept=".csv" class="hidden">
                    </label>
                </div>
            </div>
        </header>

        <!-- メインコンテンツ -->
        <div id="mainContent" class="hidden">
            <!-- 総売上サマリー -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">総売上サマリー</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="text-center p-4 bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-600">施術売上</p>
                        <p id="treatmentTotal" class="text-2xl font-bold text-gray-800">-</p>
                        <p id="treatmentComparison" class="text-sm mt-1">-</p>
                    </div>
                    <div class="text-center p-4 bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-600">物品売上</p>
                        <p id="productTotal" class="text-2xl font-bold text-gray-800">-</p>
                        <p id="productComparison" class="text-sm mt-1">-</p>
                    </div>
                    <div class="text-center p-4 bg-blue-50 rounded-lg">
                        <p class="text-sm text-gray-600">総売上</p>
                        <p id="grandTotal" class="text-2xl font-bold text-blue-800">-</p>
                        <p id="grandComparison" class="text-sm mt-1">-</p>
                    </div>
                </div>
            </div>

            <!-- 月次推移グラフ -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">売上推移</h2>
                <div style="position: relative; height:300px;">
                    <canvas id="salesChart"></canvas>
                </div>
            </div>

            <!-- 施術ランキング -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold">施術ランキング</h2>
                    <div class="flex gap-2">
                        <button onclick="showRanking('amount')" id="amountBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm">売上順</button>
                        <button onclick="showRanking('count')" id="countBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm">件数順</button>
                        <button onclick="toggleChartView()" id="chartBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm">円グラフ</button>
                    </div>
                </div>
                <div id="treatmentRanking" class="overflow-x-auto">
                    <!-- ランキングテーブル -->
                </div>
                <div id="pieChartContainer" class="hidden" style="position: relative; height:400px;">
                    <canvas id="treatmentPieChart"></canvas>
                </div>
            </div>

            <!-- 施術詳細モーダル -->
            <div id="treatmentDetailModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
                <div class="flex items-center justify-center min-h-screen p-4">
                    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[80vh] overflow-y-auto">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 id="modalTitle" class="text-xl font-semibold"></h2>
                                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            <div id="modalContent">
                                <div style="position: relative; height:400px;">
                                    <canvas id="treatmentDetailChart"></canvas>
                                </div>
                                <div id="treatmentDetailTable" class="mt-6">
                                    <!-- 詳細テーブル -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 物品サマリー -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h2 class="text-xl font-semibold mb-4">物品売上</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="p-4 border rounded-lg">
                        <h3 class="font-medium text-gray-700 mb-2">外用薬</h3>
                        <p id="externalMedicine" class="text-xl font-bold">-</p>
                        <p id="externalComparison" class="text-sm text-gray-600 mt-1">-</p>
                    </div>
                    <div class="p-4 border rounded-lg">
                        <h3 class="font-medium text-gray-700 mb-2">内服薬</h3>
                        <p id="internalMedicine" class="text-xl font-bold">-</p>
                        <p id="internalComparison" class="text-sm text-gray-600 mt-1">-</p>
                    </div>
                    <div class="p-4 border rounded-lg">
                        <h3 class="font-medium text-gray-700 mb-2">化粧品</h3>
                        <p id="cosmetics" class="text-xl font-bold">-</p>
                        <p id="cosmeticsComparison" class="text-sm text-gray-600 mt-1">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 初期メッセージ -->
        <div id="emptyState" class="text-center py-12">
            <p class="text-gray-500 text-lg">CSVファイルをアップロードしてください</p>
        </div>
    </div>

    <!-- デバッグパネル -->
    <div class="fixed bottom-4 right-4">
        <button onclick="clearAllData()" class="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700">
            データクリア
        </button>
        <button onclick="showDebugInfo()" class="px-3 py-1 bg-gray-600 text-white text-sm rounded hover:bg-gray-700 ml-2">
            デバッグ情報
        </button>
    </div>

    <script>
        // グローバル変数
        let salesData = {};
        let currentMonth = '';
        let rankingMode = 'amount';
        let salesChart = null;
        let pieChart = null;
        let showPieChart = false;
        let detailChart = null;

        // 初期化
        document.addEventListener('DOMContentLoaded', () => {
            loadStoredData();
            document.getElementById('csvFile').addEventListener('change', handleFileUpload);
            document.getElementById('monthSelector').addEventListener('change', handleMonthChange);
        });

        // ローカルストレージからデータ読み込み
        function loadStoredData() {
            const stored = localStorage.getItem('salesData');
            if (stored) {
                salesData = JSON.parse(stored);
                updateMonthSelector();
                if (Object.keys(salesData).length > 0) {
                    currentMonth = Object.keys(salesData).sort().pop();
                    document.getElementById('monthSelector').value = currentMonth;
                    displayData();
                }
            }
        }

        // CSVファイルアップロード処理
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            Papa.parse(file, {
                encoding: 'UTF-8',
                complete: function(results) {
                    processCSVData(results.data, file.name);
                },
                error: function(error) {
                    alert('CSVファイルの読み込みに失敗しました: ' + error.message);
                }
            });
        }

        // CSVデータ処理
        function processCSVData(data, filename) {
            console.log('Processing CSV data...');
            
            // ファイル名から年月を抽出 (例: 科目別売上_20250701-20250731.csv)
            const monthMatch = filename.match(/(\d{6})\d{2}/);
            if (!monthMatch) {
                alert('ファイル名から年月を特定できませんでした');
                return;
            }
            
            const yearMonth = monthMatch[1]; // 202507
            const formattedMonth = yearMonth.slice(0, 4) + '年' + yearMonth.slice(4, 6) + '月';
            
            // データ構造の初期化
            const monthData = {
                treatments: {},
                products: {
                    external: { amount: 0, count: 0 },
                    internal: { amount: 0, count: 0 },
                    cosmetics: { amount: 0, count: 0 }
                },
                totals: {
                    treatment: { amount: 0, count: 0 },
                    product: { amount: 0, count: 0 },
                    grand: { amount: 0, count: 0 }
                }
            };

            // 削除対象項目（スペースも含めて完全一致でチェック）
            const excludeItems = ['診察料（自費）', '調整金額', '予約用', '調整金額(230)'];
            
            // データ解析
            let inTreatmentSection = false;
            let inProductSection = false;
            let foundTreatmentData = false;
            let foundProductData = false;
            
            // CSVを解析してセクションと項目を特定
            for (let i = 0; i < data.length; i++) {
                const row = data[i];
                if (!row || row.length < 5) continue;
                
                // カラムの値を取得（BOMや余分な文字を除去）
                // 最初の行の最初のセルに含まれる可能性のあるBOMを除去
                let col0 = (row[0] || '').trim();
                if (i === 0 && col0.charCodeAt(0) === 0xFEFF) {
                    col0 = col0.substring(1);
                }
                // 「管理名称」の前に特殊文字がある場合も対応
                col0 = col0.replace(/^[﻿\uFEFF]+/, '');
                
                const col1 = (row[1] || '').trim();
                const col2 = (row[2] || '0').replace(/[,，"]/g, '');
                const col3 = (row[3] || '0').replace(/[,，"]/g, '');
                const col4 = (row[4] || '0').replace(/[,，"]/g, '');
                
                // デバッグ出力
                if (i < 15 || (i > 28 && i < 35)) {
                    console.log(`Row ${i}:`, {col0, col1, col2, col3});
                }
                
                // セクション判定（列0に"施術"または"物品"が含まれる）
                if (col0.includes('施術') && col1 === '') {
                    inTreatmentSection = true;
                    inProductSection = false;
                    console.log(`Row ${i}: Entering treatment section`);
                    continue;
                }
                if (col0.includes('物品') && col1 === '') {
                    inTreatmentSection = false;
                    inProductSection = true;
                    console.log(`Row ${i}: Entering product section`);
                    continue;
                }
                
                // 合計行の処理（列1にデータがある）
                if (col1 === '施術合計') {
                    monthData.totals.treatment.amount = parseInt(col2) || 0;
                    monthData.totals.treatment.count = parseInt(col3) || 0;
                    console.log(`Row ${i}: Treatment total:`, monthData.totals.treatment);
                    continue;
                }
                if (col1 === '物品合計') {
                    monthData.totals.product.amount = parseInt(col2) || 0;
                    monthData.totals.product.count = parseInt(col3) || 0;
                    console.log(`Row ${i}: Product total:`, monthData.totals.product);
                    continue;
                }
                if (col1 === '総合計') {
                    monthData.totals.grand.amount = parseInt(col2) || 0;
                    monthData.totals.grand.count = parseInt(col3) || 0;
                    console.log(`Row ${i}: Grand total:`, monthData.totals.grand);
                    continue;
                }
                
                // データ行の処理
                // 列0に項目名があり、列1が空の行がデータ行
                if (col0 && col0.length > 0 && col0 !== '管理名称' && col0 !== '施術' && col0 !== '物品' && col1 === '') {
                    // 削除対象項目をチェック（前後のスペースを除去して比較）
                    const itemNameTrimmed = col0.trim();
                    
                    // デバッグ：すべてのデータ行を表示
                    if (inTreatmentSection || inProductSection) {
                        console.log(`Row ${i}: Processing - col0:'${col0}', col2:'${col2}', col3:'${col3}'`);
                    }
                    
                    if (excludeItems.includes(itemNameTrimmed)) {
                        console.log(`Row ${i}: Excluded item:`, col0);
                        continue;
                    }
                    
                    const amount = parseInt(col2) || 0;
                    const count = parseInt(col3) || 0;
                    const avgPrice = parseInt(col4) || 0;
                    
                    // 施術項目の処理
                    if (inTreatmentSection) {
                        console.log(`Row ${i}: In treatment section - amount:${amount}, count:${count}`);
                        
                        if (amount > 0) {
                            // サブカテゴリ（【で始まる項目）を除外
                            const isSubCategory = col0.match(/^【/);
                            
                            console.log(`Row ${i}: Checking treatment - col0:'${col0}', sub:${isSubCategory}`);
                            
                            if (!isSubCategory) {
                                monthData.treatments[itemNameTrimmed] = { amount, count, avgPrice };
                                foundTreatmentData = true;
                                console.log(`Row ${i}: ✓ Added treatment:`, itemNameTrimmed, { amount, count, avgPrice });
                            } else {
                                console.log(`Row ${i}: ✗ Skipped subcategory:`, col0);
                            }
                        } else {
                            console.log(`Row ${i}: No amount for:`, col0);
                        }
                    }
                    // 物品項目の処理
                    else if (inProductSection) {
                        console.log(`Row ${i}: In product section - checking:`, itemNameTrimmed);
                        
                        if (itemNameTrimmed === '外用') {
                            monthData.products.external = { amount, count };
                            foundProductData = true;
                            console.log(`Row ${i}: Added external medicine:`, { amount, count });
                        } else if (itemNameTrimmed === '内服') {
                            monthData.products.internal = { amount, count };
                            foundProductData = true;
                            console.log(`Row ${i}: Added internal medicine:`, { amount, count });
                        } else if (itemNameTrimmed === '化粧品') {
                            monthData.products.cosmetics = { amount, count };
                            foundProductData = true;
                            console.log(`Row ${i}: Added cosmetics:`, { amount, count });
                        }
                    }
                }
            }
            
            console.log('Processed data:', monthData);
            console.log('Found treatment data:', foundTreatmentData);
            console.log('Found product data:', foundProductData);
            
            // データ保存
            salesData[formattedMonth] = monthData;
            localStorage.setItem('salesData', JSON.stringify(salesData));
            
            // 表示更新
            currentMonth = formattedMonth;
            updateMonthSelector();
            document.getElementById('monthSelector').value = currentMonth;
            displayData();
            updateChart();
            
            alert(`${formattedMonth}のデータを読み込みました`);
        }

        // 月選択セレクタの更新
        function updateMonthSelector() {
            const selector = document.getElementById('monthSelector');
            const months = Object.keys(salesData).sort();
            
            selector.innerHTML = '<option value="">月を選択</option>';
            months.forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = month;
                selector.appendChild(option);
            });
        }

        // 月変更処理
        function handleMonthChange(event) {
            currentMonth = event.target.value;
            if (currentMonth) {
                displayData();
            } else {
                document.getElementById('mainContent').classList.add('hidden');
                document.getElementById('emptyState').classList.remove('hidden');
            }
        }

        // データ表示
        function displayData() {
            if (!currentMonth || !salesData[currentMonth]) return;
            
            document.getElementById('mainContent').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            
            const data = salesData[currentMonth];
            
            // 総売上サマリー表示
            displaySummary(data);
            
            // 施術ランキング表示
            displayTreatmentRanking(data.treatments);
            
            // 物品サマリー表示
            displayProductSummary(data.products);
            
            
            // グラフ更新（複数月のデータがある場合）
            if (Object.keys(salesData).length > 0) {
                updateChart();
            }
        }

        // 総売上サマリー表示
        function displaySummary(data) {
            // 金額フォーマット
            const formatAmount = (amount) => '¥' + amount.toLocaleString();
            
            // 前月データ取得
            const months = Object.keys(salesData).sort();
            const currentIndex = months.indexOf(currentMonth);
            const previousMonth = currentIndex > 0 ? months[currentIndex - 1] : null;
            const previousData = previousMonth ? salesData[previousMonth] : null;
            
            // 比較計算
            const calculateComparison = (current, previous) => {
                if (!previous || previous === 0) return '<span class="text-gray-400">前月データなし</span>';
                const diff = current - previous;
                const percent = Math.round((diff / previous) * 100);
                const sign = diff >= 0 ? '+' : '';
                const className = diff >= 0 ? 'comparison-positive' : 'comparison-negative';
                return `<span class="${className}">${sign}${percent}% (${sign}${formatAmount(diff)})</span>`;
            };
            
            // 施術売上
            document.getElementById('treatmentTotal').textContent = formatAmount(data.totals.treatment.amount);
            document.getElementById('treatmentComparison').innerHTML = previousData ? 
                calculateComparison(data.totals.treatment.amount, previousData.totals.treatment.amount) : 
                '<span class="text-gray-400">前月データなし</span>';
            
            // 物品売上
            document.getElementById('productTotal').textContent = formatAmount(data.totals.product.amount);
            document.getElementById('productComparison').innerHTML = previousData ? 
                calculateComparison(data.totals.product.amount, previousData.totals.product.amount) : 
                '<span class="text-gray-400">前月データなし</span>';
            
            // 総売上
            document.getElementById('grandTotal').textContent = formatAmount(data.totals.grand.amount);
            document.getElementById('grandComparison').innerHTML = previousData ? 
                calculateComparison(data.totals.grand.amount, previousData.totals.grand.amount) : 
                '<span class="text-gray-400">前月データなし</span>';
        }

        // 施術ランキング表示
        function displayTreatmentRanking(treatments) {
            console.log('Displaying treatment ranking:', treatments);
            console.log('Treatment keys:', Object.keys(treatments));
            console.log('Treatment count:', Object.keys(treatments).length);
            
            if (!treatments || Object.keys(treatments).length === 0) {
                document.getElementById('treatmentRanking').innerHTML = '<p class="text-gray-500">施術データがありません</p>';
                return;
            }
            
            const sortedTreatments = Object.entries(treatments).sort((a, b) => {
                if (rankingMode === 'amount') {
                    return b[1].amount - a[1].amount;
                } else {
                    return b[1].count - a[1].count;
                }
            });
            
            let html = `
                <table class="w-full">
                    <thead>
                        <tr class="border-b">
                            <th class="text-left py-2 px-1 w-12">順位</th>
                            <th class="text-left py-2 px-2">施術名</th>
                            <th class="text-right py-2 px-2">売上金額</th>
                            <th class="text-right py-2 px-2">前月比</th>
                            <th class="text-right py-2 px-2">件数</th>
                            <th class="text-right py-2 px-2">平均単価</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // 前月データ取得
            const months = Object.keys(salesData).sort();
            const currentIndex = months.indexOf(currentMonth);
            const previousMonth = currentIndex > 0 ? months[currentIndex - 1] : null;
            const previousData = previousMonth ? salesData[previousMonth].treatments : null;
            
            sortedTreatments.forEach((item, index) => {
                const [name, data] = item;
                const rankClass = index < 3 ? `rank-${index + 1}` : '';
                
                // 前月比計算
                let changeDisplay = '<span class="text-gray-400">-</span>';
                if (previousData && previousData[name]) {
                    const prevAmount = previousData[name].amount;
                    const change = data.amount - prevAmount;
                    const changePercent = Math.round((change / prevAmount) * 100);
                    const changeClass = change >= 0 ? 'comparison-positive' : 'comparison-negative';
                    const sign = change >= 0 ? '+' : '';
                    changeDisplay = `<span class="${changeClass}">${sign}${changePercent}%</span>`;
                }
                
                html += `
                    <tr class="border-b ${rankClass} fade-in">
                        <td class="py-3 px-1">${index + 1}</td>
                        <td class="py-3 px-2"><span class="treatment-name" onclick="showTreatmentDetail('${name.replace(/'/g, "\\'")}')">${name}</span></td>
                        <td class="text-right py-3 px-2 font-semibold">¥${data.amount.toLocaleString()}</td>
                        <td class="text-right py-3 px-2">${changeDisplay}</td>
                        <td class="text-right py-3 px-2">${data.count.toLocaleString()}件</td>
                        <td class="text-right py-3 px-2">¥${data.avgPrice.toLocaleString()}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            document.getElementById('treatmentRanking').innerHTML = html;
        }

        // 物品サマリー表示
        function displayProductSummary(products) {
            const formatAmount = (amount) => '¥' + amount.toLocaleString();
            
            // 前月データ取得
            const months = Object.keys(salesData).sort();
            const currentIndex = months.indexOf(currentMonth);
            const previousMonth = currentIndex > 0 ? months[currentIndex - 1] : null;
            const previousProducts = previousMonth ? salesData[previousMonth].products : null;
            
            // 比較表示
            const showComparison = (current, previous) => {
                if (!previous || previous.amount === 0) return '前月データなし';
                const diff = current.amount - previous.amount;
                const percent = Math.round((diff / previous.amount) * 100);
                const sign = diff >= 0 ? '+' : '';
                const className = diff >= 0 ? 'comparison-positive' : 'comparison-negative';
                return `<span class="${className}">前月比: ${sign}${percent}%</span>`;
            };
            
            // 外用薬
            document.getElementById('externalMedicine').textContent = formatAmount(products.external.amount);
            document.getElementById('externalComparison').innerHTML = previousProducts ? 
                showComparison(products.external, previousProducts.external) : '前月データなし';
            
            // 内服薬
            document.getElementById('internalMedicine').textContent = formatAmount(products.internal.amount);
            document.getElementById('internalComparison').innerHTML = previousProducts ? 
                showComparison(products.internal, previousProducts.internal) : '前月データなし';
            
            // 化粧品
            document.getElementById('cosmetics').textContent = formatAmount(products.cosmetics.amount);
            document.getElementById('cosmeticsComparison').innerHTML = previousProducts ? 
                showComparison(products.cosmetics, previousProducts.cosmetics) : '前月データなし';
        }

        // グラフ更新
        function updateChart() {
            const ctx = document.getElementById('salesChart').getContext('2d');
            const months = Object.keys(salesData).sort();
            
            const chartData = {
                labels: months,
                datasets: [
                    {
                        label: '施術売上',
                        data: months.map(month => salesData[month].totals.treatment.amount),
                        backgroundColor: 'rgba(59, 130, 246, 0.8)',
                        borderColor: 'rgb(59, 130, 246)',
                        borderWidth: 1
                    },
                    {
                        label: '物品売上',
                        data: months.map(month => salesData[month].totals.product.amount),
                        backgroundColor: 'rgba(251, 146, 60, 0.8)',
                        borderColor: 'rgb(251, 146, 60)',
                        borderWidth: 1
                    }
                ]
            };

            if (salesChart) {
                salesChart.destroy();
            }

            salesChart = new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += '¥' + context.parsed.y.toLocaleString();
                                    return label;
                                },
                                afterLabel: function(context) {
                                    const monthData = salesData[context.label];
                                    if (monthData) {
                                        const total = monthData.totals.grand.amount;
                                        const percentage = Math.round((context.parsed.y / total) * 100);
                                        return `総売上の${percentage}%`;
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '¥' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // ランキング切り替え
        function showRanking(mode) {
            rankingMode = mode;
            showPieChart = false;
            
            // ボタンスタイル切り替え
            const amountBtn = document.getElementById('amountBtn');
            const countBtn = document.getElementById('countBtn');
            const chartBtn = document.getElementById('chartBtn');
            
            if (mode === 'amount') {
                amountBtn.className = 'px-4 py-2 bg-blue-600 text-white rounded-lg text-sm';
                countBtn.className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm';
            } else {
                amountBtn.className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm';
                countBtn.className = 'px-4 py-2 bg-blue-600 text-white rounded-lg text-sm';
            }
            chartBtn.className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm';
            
            // 表示切り替え
            document.getElementById('treatmentRanking').classList.remove('hidden');
            document.getElementById('pieChartContainer').classList.add('hidden');
            
            // ランキング再表示
            if (currentMonth && salesData[currentMonth]) {
                displayTreatmentRanking(salesData[currentMonth].treatments);
            }
        }
        
        // 円グラフ表示切り替え
        function toggleChartView() {
            showPieChart = !showPieChart;
            const chartBtn = document.getElementById('chartBtn');
            
            if (showPieChart) {
                chartBtn.className = 'px-4 py-2 bg-blue-600 text-white rounded-lg text-sm';
                document.getElementById('treatmentRanking').classList.add('hidden');
                document.getElementById('pieChartContainer').classList.remove('hidden');
                displayPieChart();
            } else {
                chartBtn.className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm';
                document.getElementById('treatmentRanking').classList.remove('hidden');
                document.getElementById('pieChartContainer').classList.add('hidden');
            }
        }
        
        // 円グラフ表示
        function displayPieChart() {
            if (!currentMonth || !salesData[currentMonth]) return;
            
            const treatments = salesData[currentMonth].treatments;
            const sortedTreatments = Object.entries(treatments).sort((a, b) => {
                return rankingMode === 'amount' ? b[1].amount - a[1].amount : b[1].count - a[1].count;
            });
            
            // 上位10件を取得、残りは「その他」にまとめる
            const topTreatments = sortedTreatments.slice(0, 10);
            const otherTreatments = sortedTreatments.slice(10);
            
            const labels = topTreatments.map(([name]) => name).filter(name => name && name !== 'undefined');
            const data = topTreatments.map(([name, data]) => {
                if (!name || name === 'undefined') return 0;
                return rankingMode === 'amount' ? data.amount : data.count;
            }).filter((value, index) => labels[index]);
            
            if (otherTreatments.length > 0) {
                const otherValue = otherTreatments.reduce((sum, [, data]) => {
                    return sum + (rankingMode === 'amount' ? data.amount : data.count);
                }, 0);
                labels.push('その他');
                data.push(otherValue);
            }
            
            const ctx = document.getElementById('treatmentPieChart').getContext('2d');
            
            if (pieChart) {
                pieChart.destroy();
            }
            
            pieChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(251, 146, 60, 0.8)',
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(168, 85, 247, 0.8)',
                            'rgba(236, 72, 153, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(6, 182, 212, 0.8)',
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(84, 56, 255, 0.8)',
                            'rgba(52, 211, 153, 0.8)',
                            'rgba(156, 163, 175, 0.8)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                padding: 15,
                                usePointStyle: true,
                                pointStyle: 'rectRounded',
                                font: {
                                    size: 12
                                },
                                generateLabels: function(chart) {
                                    const original = Chart.defaults.plugins.legend.labels.generateLabels;
                                    const labels = original.call(this, chart);
                                    
                                    labels.forEach((label, index) => {
                                        const value = chart.data.datasets[0].data[index];
                                        const total = chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((value / total) * 100);
                                        
                                        if (rankingMode === 'amount') {
                                            label.text = `${label.text}: ¥${value.toLocaleString()} (${percentage}%)`;
                                        } else {
                                            label.text = `${label.text}: ${value}件 (${percentage}%)`;
                                        }
                                    });
                                    
                                    return labels;
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    
                                    if (rankingMode === 'amount') {
                                        return `${label}: ¥${value.toLocaleString()} (${percentage}%)`;
                                    } else {
                                        return `${label}: ${value}件 (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }

        // データクリア
        function clearAllData() {
            if (confirm('すべてのデータを削除しますか？')) {
                localStorage.removeItem('salesData');
                salesData = {};
                currentMonth = '';
                updateMonthSelector();
                document.getElementById('mainContent').classList.add('hidden');
                document.getElementById('emptyState').classList.remove('hidden');
                if (salesChart) {
                    salesChart.destroy();
                    salesChart = null;
                }
                if (pieChart) {
                    pieChart.destroy();
                    pieChart = null;
                }
                alert('データをクリアしました');
            }
        }

        // 施術詳細表示
        function showTreatmentDetail(treatmentName) {
            const modal = document.getElementById('treatmentDetailModal');
            const modalTitle = document.getElementById('modalTitle');
            
            modalTitle.textContent = `${treatmentName}の売上推移`;
            modal.classList.remove('hidden');
            
            // 過去12ヶ月分のデータを取得
            const months = Object.keys(salesData).sort();
            const last12Months = months.slice(-12);
            
            const monthlyData = [];
            const amounts = [];
            const counts = [];
            
            last12Months.forEach(month => {
                const treatment = salesData[month].treatments[treatmentName];
                monthlyData.push(month);
                amounts.push(treatment ? treatment.amount : 0);
                counts.push(treatment ? treatment.count : 0);
            });
            
            // グラフ表示
            const ctx = document.getElementById('treatmentDetailChart').getContext('2d');
            
            if (detailChart) {
                detailChart.destroy();
            }
            
            detailChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: monthlyData,
                    datasets: [{
                        label: '売上金額',
                        data: amounts,
                        backgroundColor: 'rgba(59, 130, 246, 0.8)',
                        borderColor: 'rgb(59, 130, 246)',
                        borderWidth: 1,
                        yAxisID: 'y-amount'
                    }, {
                        label: '件数',
                        data: counts,
                        type: 'line',
                        borderColor: 'rgb(251, 146, 60)',
                        backgroundColor: 'rgba(251, 146, 60, 0.1)',
                        yAxisID: 'y-count',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.dataset.yAxisID === 'y-amount') {
                                        label += '¥' + context.parsed.y.toLocaleString();
                                    } else {
                                        label += context.parsed.y + '件';
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        'y-amount': {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '¥' + value.toLocaleString();
                                }
                            },
                            title: {
                                display: true,
                                text: '売上金額'
                            }
                        },
                        'y-count': {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            grid: {
                                drawOnChartArea: false,
                            },
                            title: {
                                display: true,
                                text: '件数'
                            }
                        }
                    }
                }
            });
            
            // 詳細テーブル作成
            let tableHtml = `
                <table class="w-full mt-4">
                    <thead>
                        <tr class="border-b">
                            <th class="text-left py-2">月</th>
                            <th class="text-right py-2">売上金額</th>
                            <th class="text-right py-2">件数</th>
                            <th class="text-right py-2">平均単価</th>
                            <th class="text-right py-2">前月比</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            last12Months.forEach((month, index) => {
                const treatment = salesData[month].treatments[treatmentName];
                if (treatment) {
                    let changeDisplay = '<span class="text-gray-400">-</span>';
                    if (index > 0) {
                        const prevMonth = last12Months[index - 1];
                        const prevTreatment = salesData[prevMonth].treatments[treatmentName];
                        if (prevTreatment && prevTreatment.amount > 0) {
                            const change = treatment.amount - prevTreatment.amount;
                            const changePercent = Math.round((change / prevTreatment.amount) * 100);
                            const changeClass = change >= 0 ? 'comparison-positive' : 'comparison-negative';
                            const sign = change >= 0 ? '+' : '';
                            changeDisplay = `<span class="${changeClass}">${sign}${changePercent}%</span>`;
                        }
                    }
                    
                    tableHtml += `
                        <tr class="border-b">
                            <td class="py-2">${month}</td>
                            <td class="text-right py-2">¥${treatment.amount.toLocaleString()}</td>
                            <td class="text-right py-2">${treatment.count}件</td>
                            <td class="text-right py-2">¥${treatment.avgPrice.toLocaleString()}</td>
                            <td class="text-right py-2">${changeDisplay}</td>
                        </tr>
                    `;
                }
            });
            
            tableHtml += '</tbody></table>';
            document.getElementById('treatmentDetailTable').innerHTML = tableHtml;
        }
        
        // モーダルを閉じる
        function closeModal() {
            document.getElementById('treatmentDetailModal').classList.add('hidden');
            if (detailChart) {
                detailChart.destroy();
                detailChart = null;
            }
        }
        
        // モーダル外側クリックで閉じる
        document.getElementById('treatmentDetailModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
        
        // デバッグ情報表示
        function showDebugInfo() {
            console.log('Current salesData:', salesData);
            console.log('Current month:', currentMonth);
            if (currentMonth && salesData[currentMonth]) {
                console.log('Current month data:', salesData[currentMonth]);
                console.log('Treatments count:', Object.keys(salesData[currentMonth].treatments).length);
                console.log('Treatments:', salesData[currentMonth].treatments);
                console.log('Products:', salesData[currentMonth].products);
            }
            alert('デバッグ情報をコンソールに出力しました（F12キーで開発者ツールを開いて確認）');
        }
    </script>
</body>
</html>